<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faça seu Pedido - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .accordion-content { overflow: hidden; transition: max-height 0.3s ease-out; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto max-w-2xl p-4 sm:p-8">
        <header class="text-center mb-8">
            <h1 id="business-name" class="text-4xl text-[#B76E79]">Carregando cardápio...</h1>
            <p class="text-gray-600 mt-2">Selecione os itens e a quantidade desejada.</p>
        </header>

        <div id="loading-state" class="text-center py-16">
            <i data-lucide="loader-2" class="mx-auto w-12 h-12 text-gray-400 animate-spin"></i>
        </div>

        <div id="error-state" class="hidden text-center py-16 bg-red-50 p-8 rounded-lg">
            <i data-lucide="frown" class="mx-auto w-12 h-12 text-red-500"></i>
            <h2 class="text-2xl mt-4 text-red-700">Link Inválido</h2>
            <p class="text-gray-600">Não foi possível carregar o cardápio. Por favor, solicite um novo link.</p>
        </div>

        <div id="content-container" class="hidden space-y-8">
            <div id="categories-container" class="space-y-4">
                <!-- Categorias e itens serão inseridos aqui -->
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-md space-y-4">
                <h3 class="text-2xl text-gray-800 border-b pb-2">Seus Dados</h3>
                <div>
                    <label for="customer-name" class="block text-gray-700 mb-2 font-semibold">Nome Completo</label>
                    <input type="text" id="customer-name" class="w-full p-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="customer-phone" class="block text-gray-700 mb-2 font-semibold">Telefone (WhatsApp)</label>
                    <input type="tel" id="customer-phone" class="w-full p-2 border rounded-lg" placeholder="(XX) X XXXX-XXXX" required>
                </div>
                 <div>
                    <label for="customer-obs" class="block text-gray-700 mb-2 font-semibold">Observações</label>
                    <textarea id="customer-obs" class="w-full p-2 border rounded-lg" rows="3" placeholder="Alguma observação sobre o pedido?"></textarea>
                </div>
                <div>
                    <label for="payment-method" class="block text-gray-700 mb-2 font-semibold">Forma de Pagamento</label>
                    <select id="payment-method" class="w-full p-2 border rounded-lg">
                        <option>Dinheiro</option>
                        <option>PIX</option>
                        <option>Cartão de Crédito</option>
                        <option>Cartão de Débito</option>
                    </select>
                </div>
            </div>

            <div id="order-summary" class="sticky bottom-0 bg-white p-4 rounded-t-2xl shadow-lg border-t-4 border-[#B76E79]">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold text-gray-800">TOTAL</span>
                    <span id="total-price" class="text-2xl font-bold text-[#B76E79]">R$ 0,00</span>
                </div>
                <button id="send-order-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2 text-lg">
                    <i data-lucide="send"></i> Enviar Pedido via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <script>lucide.createIcons();</script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Cole sua configuração do Firebase aqui, ou importe do config.js
        const firebaseConfig = {
            apiKey: "AIzaSyBgxaY8zFm8wwBzXEB9F4UpBZm4e8dLdEg",
            authDomain: "bronzify-b2491.firebaseapp.com",
            projectId: "bronzify-b2491",
            storageBucket: "bronzify-b2491.appspot.com",
            messagingSenderId: "399230151633",
            appId: "1:399230151633:web:8839c2e384a9301d8ecef0"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const categoriesContainer = document.getElementById('categories-container');
        
        async function main() {
            const urlParams = new URLSearchParams(window.location.search);
            const businessId = urlParams.get('businessId');

            if (!businessId) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                return;
            }

            try {
                // Fetch categories and products in parallel
                const categoriesRef = collection(db, "businesses", businessId, "stock_categories");
                const itemsRef = collection(db, "businesses", businessId, "stock_items");
                
                const [categoriesSnapshot, itemsSnapshot] = await Promise.all([
                    getDocs(query(categoriesRef, orderBy("name"))),
                    getDocs(query(itemsRef, orderBy("name")))
                ]);

                const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const items = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderMenu(categories, items);

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('content-container').classList.remove('hidden');
                document.getElementById('business-name').textContent = "Nosso Cardápio"; // Você pode buscar o nome da empresa se tiver
            } catch (error) {
                console.error("Error fetching data: ", error);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
            }
        }

        function renderMenu(categories, items) {
            categoriesContainer.innerHTML = '';
            categories.forEach(category => {
                const itemsInCategory = items.filter(item => item.categoryId === category.id);
                if (itemsInCategory.length === 0) return;

                const categoryDiv = document.createElement('div');
                categoryDiv.innerHTML = `
                    <div data-accordion-trigger class="flex justify-between items-center cursor-pointer bg-white p-4 rounded-lg shadow">
                        <h3 class="text-xl text-gray-800">${category.name}</h3>
                        <i data-lucide="chevron-down" class="transition-transform duration-300"></i>
                    </div>
                    <div class="accordion-content max-h-0 bg-white rounded-b-lg shadow">
                        <div class="p-4 space-y-4">
                            ${itemsInCategory.map(item => `
                                <div class="item-row flex justify-between items-center" data-id="${item.id}" data-price="${item.price}" data-name="${item.name}">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="item-${item.id}" class="item-checkbox h-5 w-5 rounded">
                                        <label for="item-${item.id}" class="font-semibold text-gray-700">${item.name}</label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-600">${(item.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                        <input type="number" min="1" value="1" class="item-quantity w-16 p-1 border rounded-md text-center hidden">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                categoriesContainer.appendChild(categoryDiv);
            });
            lucide.createIcons();
            addEventListeners();
        }

        function addEventListeners() {
            categoriesContainer.querySelectorAll('[data-accordion-trigger]').forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const panel = trigger.nextElementSibling;
                    const icon = trigger.querySelector('i');
                    if (panel.style.maxHeight) {
                        panel.style.maxHeight = null;
                        icon.classList.remove('rotate-180');
                    } else {
                        panel.style.maxHeight = panel.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                });
            });

            categoriesContainer.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const quantityInput = e.target.closest('.item-row').querySelector('.item-quantity');
                    quantityInput.classList.toggle('hidden', !e.target.checked);
                    calculateTotal();
                });
            });
            
            categoriesContainer.querySelectorAll('.item-quantity').forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

            document.getElementById('send-order-btn').addEventListener('click', sendOrder);

            const phoneInput = document.getElementById('customer-phone');
            phoneInput.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '').substring(0, 11);
                v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
                v = v.replace(/(\d{5})(\d)/, '$1-$2');
                e.target.value = v;
            });
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const checkbox = row.querySelector('.item-checkbox');
                if (checkbox.checked) {
                    const price = parseFloat(row.dataset.price);
                    const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                    total += price * quantity;
                }
            });
            document.getElementById('total-price').textContent = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function sendOrder() {
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            if (!name || !phone) {
                alert('Por favor, preencha seu nome e telefone.');
                return;
            }

            let orderDetails = '';
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                if (row.querySelector('.item-checkbox').checked) {
                    const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                    if(quantity > 0) {
                        const itemName = row.dataset.name;
                        const itemPrice = parseFloat(row.dataset.price);
                        total += itemPrice * quantity;
                        orderDetails += `- ${quantity}x ${itemName}\n`;
                    }
                }
            });

            if (orderDetails === '') {
                alert('Por favor, selecione pelo menos um item.');
                return;
            }

            const obs = document.getElementById('customer-obs').value.trim();
            const payment = document.getElementById('payment-method').value;

            let message = `*--- Novo Pedido ---*\n\n`;
            message += `*Cliente:* ${name}\n`;
            message += `*Telefone:* ${phone}\n\n`;
            message += `*Itens do Pedido:*\n${orderDetails}\n`;
            if (obs) message += `*Observações:* ${obs}\n\n`;
            message += `*Forma de Pagamento:* ${payment}\n`;
            message += `*Total do Pedido: ${total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}*`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        main();
    </script>
</body>
</html>
