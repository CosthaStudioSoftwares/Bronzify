<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renovar Assinatura - Bronzify</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bronzify">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        /* Adiciona um estilo para o loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #B76E79;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-8 text-center">
        <h1 class="text-4xl text-[#B76E79]">Renovar Assinatura</h1>
        <p class="text-gray-600 mt-2">Seu acesso expirou ou está prestes a expirar. Renove agora para continuar usando o sistema.</p>

        <div id="payment-container" class="mt-8">
            <div id="loading-payment" class="text-center flex flex-col items-center">
                <div class="loader"></div>
                <p class="mt-4 text-gray-600 animate-pulse">Gerando seu pagamento, aguarde um instante...</p>
            </div>

            <div id="payment-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="text-center">
                        <h3 class="text-xl font-bold">1. Pague com PIX</h3>
                        <p class="text-sm text-gray-500">Escaneie o código abaixo com o app do seu banco.</p>
                        <img id="pix-qrcode" src="" alt="QR Code PIX" class="mx-auto border-4 border-gray-200 rounded-lg mt-4">
                        <p class="mt-4 font-semibold text-sm">Ou use o PIX Copia e Cola:</p>
                        <textarea readonly id="pix-code" class="w-full p-2 mt-1 text-xs border rounded-md bg-gray-100 h-24"></textarea>
                        <button id="copy-btn" class="mt-2 bg-gray-200 text-gray-800 px-4 py-2 text-sm rounded-lg hover:bg-gray-300">Copiar Código</button>
                    </div>
                    <div class="text-center border-t md:border-t-0 md:border-l pt-6 md:pt-0 md:pl-8 border-dashed">
                        <h3 class="text-xl font-bold">2. Cartão de Crédito</h3>
                        <p class="text-sm text-gray-500 mt-2">No momento, estamos finalizando a integração com cartão.</p>
                        <p class="mt-4 text-lg p-4 bg-rose-50 text-rose-700 rounded-lg">Por enquanto, por favor, utilize o **PIX** para renovação imediata.</p>
                    </div>
                </div>
                <p class="mt-8 text-sm text-gray-500">Após a confirmação do pagamento, seu acesso será liberado automaticamente. Você pode recarregar a página ou <a href="./dashboard.html" class="text-[#B76E79] underline">clicar aqui</a>.</p>
            </div>
        </div>

        <button id="logout-btn" class="mt-8 text-sm text-gray-500 hover:underline">Sair e tentar mais tarde</button>
    </div>

    <script>
        // Renderiza os ícones da página
        lucide.createIcons();
    </script>
    
    <script src="./config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'southamerica-east1'); // Confirme se sua região é esta

        const loadingDiv = document.getElementById('loading-payment');
        const contentDiv = document.getElementById('payment-content');
        const qrCodeImg = document.getElementById('pix-qrcode');
        const pixCodeText = document.getElementById('pix-code');
        const copyBtn = document.getElementById('copy-btn');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Se o usuário está logado, chama a Cloud Function para criar o pedido
                const createOrder = httpsCallable(functions, 'createPagBankOrder');
                createOrder()
                    .then((result) => {
                        const { qrCodeText, qrCodeImage } = result.data;
                        
                        // Preenche os dados do PIX na tela
                        qrCodeImg.src = qrCodeImage;
                        pixCodeText.value = qrCodeText;
                        
                        // Esconde o loading e mostra o conteúdo do pagamento
                        loadingDiv.classList.add('hidden');
                        contentDiv.classList.remove('hidden');

                        // Adiciona a funcionalidade ao botão de copiar
                        copyBtn.addEventListener('click', () => {
                            navigator.clipboard.writeText(qrCodeText);
                            copyBtn.textContent = 'Copiado!';
                            setTimeout(() => { copyBtn.textContent = 'Copiar Código' }, 2000);
                        });
                    })
                    .catch((error) => {
                        console.error("Erro ao criar pedido de pagamento:", error);
                        loadingDiv.innerHTML = '<p class="text-red-500 font-semibold">Ocorreu um erro ao gerar seu pagamento. Por favor, recarregue a página e tente novamente.</p>';
                    });
            } else {
                // Se não há usuário logado, volta para a tela de login
                window.location.href = './index.html';
            }
        });

        // Lógica do botão de logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'index.html');
        });
    </script>
</body>
</html>
