<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bronzify">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: #4A5568; transition: all 0.3s ease; font-weight: 500; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #B76E79; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.open { transform: translateX(0); }
        .toast-success { transform: translateY(100%); opacity: 0; transition: transform 0.5s ease-out, opacity 0.5s ease-out; }
        .toast-success.show { transform: translateY(0); opacity: 1; }
        /* Estilos para o novo menu dropdown */
        .dropdown-content {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 opacity-0 transition-opacity duration-300">

    <div class="flex h-screen">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                <h2 class="text-3xl lg:text-4xl text-gray-800">Dashboard</h2>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="relative">
                        <button id="settings-menu-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                            <i data-lucide="settings" class="w-6 h-6 text-gray-700"></i>
                        </button>
                        <div id="settings-dropdown" class="dropdown-content absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl z-50 p-2 opacity-0 transform scale-95 pointer-events-none">
                            <a href="#" class="flex items-center gap-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-md text-sm"><i data-lucide="dollar-sign" class="w-4 h-4"></i>Configurações do Caixa</a>
                            <a href="#" class="flex items-center gap-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-md text-sm"><i data-lucide="users" class="w-4 h-4"></i>Configurações de Acesso</a>
                        </div>
                    </div>
                    <img src="https://placehold.co/40x40/FADADD/B76E79?text=B" alt="Avatar" class="rounded-full">
                </div>
            </header>
            <div class="bg-white p-4 rounded-2xl shadow-md mb-8 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-2 sm:gap-3 flex-wrap">
                    <h3 class="text-lg font-semibold text-gray-700 w-full sm:w-auto">Filtros:</h3>
                    <select id="filter-month" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79] w-full sm:w-auto"></select>
                    <select id="filter-year" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79] w-full sm:w-auto"></select>
                    <button id="filter-apply" class="bg-[#B76E79] text-white px-4 py-2 rounded-lg hover:opacity-90 w-full sm:w-auto">Aplicar</button>
                </div>
                <div class="flex items-center gap-3 w-full sm:w-auto justify-center">
                    <button id="share-btn" class="flex items-center gap-2 p-2 border rounded-lg text-gray-600 hover:bg-gray-100"><i data-lucide="share-2"></i> <span class="hidden sm:inline">Compartilhar</span></button>
                    <button id="download-btn" class="flex items-center gap-2 p-2 border rounded-lg text-gray-600 hover:bg-gray-100"><i data-lucide="download"></i> <span class="hidden sm:inline">Baixar PDF</span></button>
                </div>
            </div>
            <div id="report-content">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md flex flex-col justify-between">
                        <div>
                            <h3 id="subscription-card-title" class="text-lg font-semibold text-gray-500">Status da Assinatura</h3>
                            <p id="subscription-days" class="text-3xl sm:text-4xl font-bold text-[#B76E79] mt-2">Carregando...</p>
                            <p id="subscription-status-text" class="text-sm text-gray-500 mt-1 h-5"></p>
                        </div>
                        <button id="renew-btn" class="w-full mt-4 bg-emerald-500 text-white font-semibold py-2 rounded-lg hover:bg-emerald-600 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="party-popper"></i><span>Renovar Assinatura</span>
                        </button>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 id="revenue-title" class="text-lg font-semibold text-gray-500">Faturamento Mensal</h3>
                        <p id="monthly-revenue" class="text-3xl sm:text-4xl font-bold text-[#B76E79] mt-2">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Faturamento Diário</h3>
                        <p id="daily-revenue" class="text-3xl sm:text-4xl font-bold text-[#B76E79] mt-2">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 id="appointments-title" class="text-lg font-semibold text-gray-500">Atendimentos no Dia</h3>
                        <p id="daily-appointments" class="text-3xl sm:text-4xl font-bold text-[#B76E79] mt-2">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
                        <h3 id="payment-details-title" class="text-2xl text-gray-800 mb-4">Faturamento por Pagamento</h3>
                        <div id="payment-methods-details" class="space-y-4"><p class="text-gray-500">Carregando dados...</p></div>
                    </div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-md">
                        <h3 id="services-chart-title" class="text-2xl text-gray-800 mb-4">Serviços (Mês)</h3>
                        <div id="chart-container" class="h-80 flex justify-center items-center"><canvas id="servicesChart"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            </div>
        
        <div id="help-alert-modal" class="fixed bottom-8 right-8 bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm z-50 transform translate-y-full opacity-0 transition-all duration-300 ease-out">
            </div>
    </div>
    
    <div id="payment-success-toast" class="toast-success fixed bottom-8 right-8 bg-green-500 text-white p-4 rounded-xl shadow-lg flex items-center gap-3 z-[100]">
        <i data-lucide="check-circle" class="w-6 h-6"></i>
        <span>Pagamento confirmado! Sua assinatura foi renovada.</span>
    </div>

    <script> lucide.createIcons(); const { jsPDF } = window.jspdf; </script>
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'southamerica-east1');

        // Código omitido para brevidade (validações, etc.) ...
        
        let dashboardDataCache = null;
        let currentUser = null;
        // Variáveis de admin removidas
        
        const monthSelect = document.getElementById('filter-month');
        const yearSelect = document.getElementById('filter-year');
        const ctx = document.getElementById('servicesChart').getContext('2d');
        const servicesChart = new Chart(ctx, { /* Configuração do gráfico */ });

        // NOVO: Lógica do menu de configurações
        const settingsMenuBtn = document.getElementById('settings-menu-btn');
        const settingsDropdown = document.getElementById('settings-dropdown');

        settingsMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsDropdown.classList.toggle('opacity-0');
            settingsDropdown.classList.toggle('scale-95');
            settingsDropdown.classList.toggle('pointer-events-none');
        });

        document.addEventListener('click', () => {
            if (!settingsDropdown.classList.contains('opacity-0')) {
                settingsDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await checkUserPlan(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function checkUserPlan(user) {
            const userProfileRef = doc(db, "users", user.uid);
            onSnapshot(userProfileRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().plan?.expiresAt) {
                    // ... (lógica de verificação de plano existente)
                    sessionStorage.setItem('acessoLiberado', 'true');
                    if (document.body.classList.contains('opacity-0')) {
                        initializeDashboard(user);
                        document.body.classList.remove('opacity-0');
                    }
                } else {
                    window.location.href = './assinatura.html';
                }
            });
        }
        
        async function initializeDashboard(user) {
            await fetchDashboardData(); // Carrega os dados imediatamente
            // a lógica de senha de admin foi removida
        }

        function updateUIVisibility(){
            const monthlyRevenueEl = document.getElementById("monthly-revenue");
            const dailyRevenueEl = document.getElementById("daily-revenue");
            const paymentDetailsEl = document.getElementById("payment-methods-details");
            const chartContainer = document.getElementById("chart-container");
            const appointmentsTitleEl = document.getElementById("appointments-title");
            const dailyAppointmentsEl = document.getElementById("daily-appointments");
            const paymentDetailsTitleEl = document.getElementById("payment-details-title");

            // Se não houver dados, exibe "Carregando..."
            if (!dashboardDataCache) {
                monthlyRevenueEl.textContent = "Carregando...";
                dailyRevenueEl.textContent = "Carregando...";
                dailyAppointmentsEl.textContent = "...";
                return;
            }

            // Sempre exibe os dados, pois não há mais modo admin
            monthlyRevenueEl.textContent = dashboardDataCache.monthlyRevenue.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
            dailyRevenueEl.textContent = dashboardDataCache.dailyRevenue.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
            
            const totalsSource = dashboardDataCache.isFilteredPeriod ? dashboardDataCache.periodPaymentMethodTotals : dashboardDataCache.dailyPaymentMethodTotals;
            
            appointmentsTitleEl.textContent = dashboardDataCache.isFilteredPeriod ? "Atendimentos no Período" : "Atendimentos no Dia";
            dailyAppointmentsEl.textContent = dashboardDataCache.isFilteredPeriod ? dashboardDataCache.periodAppointments : dashboardDataCache.dailyAppointments;
            paymentDetailsTitleEl.textContent = dashboardDataCache.isFilteredPeriod ? "Faturamento por Pagamento no Período" : "Faturamento Diário por Pagamento";

            paymentDetailsEl.innerHTML = "";
            if (Object.keys(totalsSource).length > 0) {
                Object.keys(totalsSource).forEach(method => {
                    paymentDetailsEl.innerHTML += `<div class="flex justify-between items-center"><span class="text-gray-600">${method}</span><span class="font-bold text-gray-800">${totalsSource[method].toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</span></div>`;
                });
            } else {
                paymentDetailsEl.innerHTML = `<p class="text-gray-500">${dashboardDataCache.isFilteredPeriod ? 'Nenhuma venda no período.' : 'Nenhuma venda hoje.'}</p>`;
            }

            chartContainer.style.opacity = 1;
            lucide.createIcons();
        }

        async function fetchDashboardData(isFiltered = false) {
            if (!currentUser) return;

            const selectedMonth = parseInt(monthSelect.value);
            const selectedYear = parseInt(yearSelect.value);
            let startDate, endDate;

            const revenueTitleEl = document.getElementById("revenue-title");
            const servicesChartTitleEl = document.getElementById("services-chart-title");

            if (selectedMonth === 12) { // Ano Inteiro
                startDate = new Date(selectedYear, 0, 1);
                endDate = new Date(selectedYear, 11, 31, 23, 59, 59);
                revenueTitleEl.textContent = "Faturamento Anual";
                servicesChartTitleEl.textContent = "Serviços (Ano)";
            } else { // Mês Específico
                startDate = new Date(selectedYear, selectedMonth, 1);
                endDate = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59);
                revenueTitleEl.textContent = "Faturamento Mensal";
                servicesChartTitleEl.textContent = "Serviços (Mês)";
            }
            
            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
            const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
            
            const salesRef = collection(db, "businesses", currentUser.uid, "sales");
            const periodQuery = query(salesRef, where("createdAt", ">=", Timestamp.fromDate(startDate)), where("createdAt", "<=", Timestamp.fromDate(endDate)));
            const todayQuery = query(salesRef, where("createdAt", ">=", Timestamp.fromDate(todayStart)), where("createdAt", "<=", Timestamp.fromDate(todayEnd)));
            
            try {
                const [periodSnapshot, todaySnapshot] = await Promise.all([getDocs(periodQuery), getDocs(todayQuery)]);
                
                let monthlyRevenue = 0, dailyRevenue = 0;
                const serviceCounts = {}, periodPaymentTotals = {}, dailyPaymentTotals = {};
                
                periodSnapshot.forEach(doc => {
                    const sale = doc.data();
                    monthlyRevenue += sale.total || 0;
                    if(sale.items) sale.items.forEach(item => { serviceCounts[item.name] = (serviceCounts[item.name] || 0) + 1; });
                    const method = sale.paymentMethod || "N/A";
                    periodPaymentTotals[method] = (periodPaymentTotals[method] || 0) + sale.total;
                });

                todaySnapshot.forEach(doc => {
                    const sale = doc.data();
                    dailyRevenue += sale.total || 0;
                    const method = sale.paymentMethod || "N/A";
                    dailyPaymentTotals[method] = (dailyPaymentTotals[method] || 0) + sale.total;
                });

                dashboardDataCache = {
                    monthlyRevenue: monthlyRevenue,
                    dailyRevenue: dailyRevenue,
                    dailyPaymentMethodTotals: dailyPaymentTotals,
                    dailyAppointments: todaySnapshot.size,
                    serviceCounts: serviceCounts,
                    periodAppointments: periodSnapshot.size,
                    periodPaymentMethodTotals: periodPaymentTotals,
                    isFilteredPeriod: isFiltered,
                };
                
                servicesChart.data.labels = Object.keys(serviceCounts);
                servicesChart.data.datasets[0].data = Object.values(serviceCounts);
                servicesChart.update();
                
                updateUIVisibility();

            } catch (error) {
                console.error("Erro ao buscar dados do dashboard: ", error);
            }
        }

        document.getElementById("filter-apply").addEventListener("click", () => fetchDashboardData(true));
        
        // As demais funções (download, compartilhar, pagamento) permanecem as mesmas
        // ...
    </script>
</body>
</html>
