<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pátio - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bronzify">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: #4A5568; transition: all 0.3s ease; font-weight: 500; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .sidebar-link svg { margin-right: 0.75rem; }
        .patio-card { transition: opacity 0.5s ease, transform 0.5s ease, box-shadow 0.3s ease; }
        .patio-card.removing { opacity: 0; transform: scale(0.95); }
        .patio-card.needs-attention { box-shadow: 0 0 0 4px #FBBF24; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(251, 191, 36, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); } }
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.open { transform: translateX(0); }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex items-center w-full">
                    <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                    <h2 class="text-3xl lg:text-4xl text-gray-800 w-full text-center sm:text-left">Pátio</h2>
                </div>
                <button id="help-btn" class="w-full sm:w-auto bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 flex items-center justify-center gap-2 flex-shrink-0">
                    <i data-lucide="bell-ring"></i> Pedir Ajuda
                </button>
            </header>

            <div id="patio-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            
            <div id="no-clients-patio" class="text-center py-16 text-gray-500 hidden">
                <i data-lucide="sun" class="mx-auto w-16 h-16 mb-4"></i>
                <p class="text-xl">O pátio está vazio no momento.</p>
            </div>
        </main>
    </div>
    <script>
      lucide.createIcons();
    </script>
    
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, updateDoc, getDocs, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let allProducts = [];
        let localIntervals = {};
        let activeModals = new Set();
        let patioClientsData = []; // Cache local dos dados dos clientes

        const TANNING_PHASES = [
            { name: "Frente", image: "frente.png", instruction: "Por favor, posicione a cliente de FRENTE." },
            { name: "Costas", image: "costas.png", instruction: "Por favor, posicione a cliente de COSTAS." },
            { name: "Lado Esquerdo", image: "lado_esquerdo.png", instruction: "Por favor, posicione a cliente de LADO ESQUERDO." },
            { name: "Lado Direito", image: "lado_direito.png", instruction: "Por favor, posicione a cliente de LADO DIREITO." },
        ];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadProductsAndListenForClients();
            } else { window.location.href = './index.html'; }
        });
        
        async function loadProductsAndListenForClients() {
            if (!currentUser) return;
            try {
                const productsRef = collection(db, "businesses", currentUser.uid, "products");
                const productsSnapshot = await getDocs(productsRef);
                allProducts = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                listenForPatioClients();
            } catch (error) { console.error("Erro ao carregar produtos:", error); }
        }

        const patioListContainer = document.getElementById('patio-list');
        const noClientsMessage = document.getElementById('no-clients-patio');

        function listenForPatioClients() {
            if (!currentUser) return;
            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
            const salesRef = collection(db, "businesses", currentUser.uid, "sales");
            const q = query(salesRef, orderBy("createdAt", "asc"));

            onSnapshot(q, (querySnapshot) => {
                patioClientsData = querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(sale => sale.status === 'called' && sale.createdAt.toDate() >= todayStart);

                noClientsMessage.classList.toggle('hidden', patioClientsData.length === 0);
                const existingCards = new Set(Array.from(patioListContainer.children).map(c => c.id));
                const clientsOnScreen = new Set(patioClientsData.map(c => `sale-${c.id}`));

                existingCards.forEach(cardId => {
                    if (!clientsOnScreen.has(cardId)) {
                        const cleanId = cardId.replace('sale-', '');
                        document.getElementById(cardId)?.remove();
                        if (localIntervals[cleanId]) clearInterval(localIntervals[cleanId]);
                        delete localIntervals[cleanId];
                    }
                });

                patioClientsData.forEach((sale) => {
                    let card = document.getElementById(`sale-${sale.id}`);
                    if (!card) {
                        card = createClientCard(sale);
                        patioListContainer.appendChild(card);
                    }
                    updateClientCard(sale);
                });
                lucide.createIcons();
            });
        }

        function createClientCard(sale) { /* ... (código mantido da versão anterior) */ }
        function updateClientCard(sale) { /* ... (código mantido da versão anterior) */ }
        function handleTimerState(sale) { /* ... (código mantido da versão anterior) */ }
        
        async function showSystemNotification(sale) {
            const { id: saleId, clientName, timerState } = sale;
            const nextPhaseIndex = timerState.currentPhase + 1;
            const title = "Bronzify: Tempo Esgotado!";
            const body = nextPhaseIndex < TANNING_PHASES.length
                ? `Toque para continuar o bronze da ${clientName}.`
                : `Toque para finalizar o bronze da ${clientName}.`;
            
            const options = {
                body: body,
                icon: 'icon-192x192.png',
                vibrate: [200, 100, 200], // Vibração
                data: { saleId: saleId } // Envia o ID da venda para o service worker
            };

            if ('serviceWorker' in navigator && navigator.serviceWorker.ready) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification(title, options);
                });
            }
        }

        async function handlePhaseEnd(sale) {
            const { id: saleId, timerState } = sale;
            if (timerState.status !== 'running') return;

            const saleRef = doc(db, "businesses", currentUser.uid, "sales", saleId);
            await updateDoc(saleRef, { "timerState.status": "paused" });
            
            showSystemNotification(sale);
        }

        async function triggerConfirmationModal(sale) {
            const { id: saleId, clientName, timerState } = sale;
            if (activeModals.has(saleId)) return;
            activeModals.add(saleId);

            document.getElementById(`sale-${saleId}`)?.classList.add('needs-attention');

            const nextPhaseIndex = timerState.currentPhase + 1;
            const instruction = nextPhaseIndex < TANNING_PHASES.length 
                ? TANNING_PHASES[nextPhaseIndex].instruction 
                : `${clientName} finalizou todas as posições!`;

            const confirmed = await showConfirm(instruction, 'MUDANÇA DE POSIÇÃO', 'Confirmar');
            
            document.getElementById(`sale-${saleId}`)?.classList.remove('needs-attention');
            activeModals.delete(saleId);
            
            const saleRef = doc(db, "businesses", currentUser.uid, "sales", saleId);
            if (confirmed) {
                const updateData = nextPhaseIndex < TANNING_PHASES.length
                    ? { "timerState.currentPhase": nextPhaseIndex, "timerState.phaseStartedAt": Timestamp.now(), "timerState.status": "running" }
                    : { "timerState.status": "finished" };
                await updateDoc(saleRef, updateData);
            }
        }
        
        function resetCardUIToIdle(saleId) { /* ... (código mantido) */ }
        function updateCardUIToRunning(saleId, timerState) { /* ... (código mantido) */ }
        function updateCardUIToFinished(saleId) { /* ... (código mantido) */ }
        
        patioListContainer.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target || !currentUser) return;

            const saleId = target.closest('.timer-section')?.dataset.saleId || target.dataset.id;
            const saleRef = doc(db, "businesses", currentUser.uid, "sales", saleId);

            if (target.classList.contains('start-timer-btn')) {
                if (Notification.permission === 'denied') {
                    alert('As notificações estão bloqueadas. Por favor, habilite nas configurações do seu navegador para usar o timer.');
                    return;
                }
                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        alert('Permissão para notificações é necessária para os alertas do timer.');
                        return;
                    }
                }
                
                target.disabled = true;
                target.innerHTML = `<i data-lucide="timer" class="w-5 h-5"></i> Em Andamento`;
                lucide.createIcons();
                
                const selectedMinutes = document.getElementById(`time-select-${saleId}`).value;
                await updateDoc(saleRef, {
                    timerState: { status: 'running', currentPhase: 0, phaseDurationSeconds: parseInt(selectedMinutes) * 60, phaseStartedAt: Timestamp.now() }
                });
            }

            if (target.classList.contains('finish-btn')) {
                /* ... (código mantido da versão anterior) */
            }
        });
        
        patioListContainer.addEventListener('change', async (e) => { /* ... (código mantido) */ });

        // NOVO: Ouve as mensagens do Service Worker
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'NOTIFICATION_CLICK') {
                const saleId = event.data.saleId;
                const sale = patioClientsData.find(c => c.id === saleId);
                if (sale && sale.timerState && sale.timerState.status === 'paused') {
                    triggerConfirmationModal(sale);
                }
            }
        });

    </script>
</body>
</html>
