<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
        if (sessionStorage.getItem('acessoLiberado') !== 'true') {
            window.location.href = 'dashboard.html';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bronzify">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: #4A5568; transition: all 0.3s ease; font-weight: 500; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .sidebar-link svg { margin-right: 0.75rem; }
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.open { transform: translateX(0); }
        tbody tr:hover { background-color: #f9fafb; }
        .notification-alert { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        /* Esconde o ícone de calendário padrão do campo de data */
input[type="date"]::-webkit-calendar-picker-indicator {
    display: none;
    -webkit-appearance: none;
}
    </style>
</head>
<body class="bg-gray-50">

   <div class="flex h-screen bg-gray-50">
       <div class="flex-1 flex flex-col overflow-hidden">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex items-center">
                    <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                    <h2 class="text-3xl lg:text-4xl text-gray-800 ml-2 sm:ml-0">Controle de Estoque</h2>
                </div>
                <div class="flex items-center gap-2">
                    <button id="share-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">
                        <i data-lucide="share-2"></i> <span>Compartilhar Link</span>
                    </button>
                    <button id="add-item-btn" class="bg-[#B76E79] text-white px-4 py-2 rounded-lg hover:opacity-90 flex items-center justify-center gap-2">
                        <i data-lucide="plus"></i> <span>Cadastrar Item</span>
                    </button>
                </div>
            </header>

            <div class="bg-white p-4 rounded-2xl shadow-md mb-8 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="text" id="search-input" placeholder="Buscar por nome ou código..." class="w-full p-2 border rounded-lg">
                    <select id="category-filter" class="w-full p-2 border rounded-lg"></select>
                    <button id="expiry-filter-btn" class="w-full p-2 border rounded-lg flex items-center justify-center gap-2 hover:bg-amber-50 text-amber-600 font-semibold"><i data-lucide="calendar-clock"></i>Vencimento Próximo</button>
                    <button id="restock-filter-btn" class="w-full p-2 border rounded-lg flex items-center justify-center gap-2 hover:bg-red-50 text-red-600 font-semibold"><i data-lucide="package-x"></i>Necessita Reposição</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-md">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[700px]">
                        <thead>
                            <tr class="border-b"><th class="p-3">Código</th><th class="p-3">Produto</th><th class="p-3">Categoria</th><th class="p-3">Validade</th><th class="p-3 text-center">Qtd.</th><th class="p-3">Valor</th><th class="p-3 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="stock-table-body"></tbody>
                    </table>
                </div>
                <div id="pagination-controls" class="mt-6 flex justify-between items-center"></div>
            </div>
        </main>
           </div>
    </div>

    <div id="alerts-panel" class="fixed bottom-5 right-5 space-y-2 z-40"></div>

    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8">
            <h3 id="item-modal-title" class="text-2xl text-gray-800 mb-6">Cadastrar Novo Item</h3>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label for="item-code" class="block text-gray-600 mb-2">Código do Produto</label><input type="text" id="item-code" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label for="item-name" class="block text-gray-600 mb-2">Nome do Produto</label><input type="text" id="item-name" class="w-full px-4 py-2 border rounded-lg" required></div>
                </div>
                 <div>
                    <label for="item-category" class="block text-gray-600 mb-2">Categoria</label>
                    <div class="flex gap-2">
                        <select id="item-category" class="w-full px-4 py-2 border rounded-lg" required></select>
                        <button type="button" id="manage-categories-btn" class="p-2 border rounded-lg hover:bg-gray-100" title="Gerenciar categorias"><i data-lucide="settings-2"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div><label for="item-price" class="block text-gray-600 mb-2">Valor</label><input type="text" id="item-price" placeholder="R$ 0,00" class="w-full px-4 py-2 border rounded-lg" required></div>
                   <div><label for="item-expiry" class="block text-gray-600 mb-2">Validade</label><input type="date" id="item-expiry" class="w-full px-4 py-2 border rounded-lg"></div>
                    <div><label for="item-quantity" class="block text-gray-600 mb-2">Quantidade</label><input type="number" id="item-quantity" value="1" min="0" class="w-full px-4 py-2 border rounded-lg" required></div>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-btn" class="px-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-[#B76E79] text-white rounded-lg hover:opacity-90">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <h3 class="text-2xl text-gray-800 mb-6">Gerenciar Categorias</h3>
            <div id="category-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto p-1"></div>
            <form id="category-form" class="flex gap-2">
                <input type="text" id="category-name-input" placeholder="Nome da nova categoria" class="w-full px-4 py-2 border rounded-lg" required>
                <input type="hidden" id="category-id-input">
                <button type="submit" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 shrink-0"><i data-lucide="plus"></i></button>
            </form>
            <button type="button" id="close-category-modal-btn" class="w-full mt-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>

    <script>lucide.createIcons();</script>
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allStockItems = [];
        let allCategories = [];
        let currentItemList = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 5;

        const tableBody = document.getElementById('stock-table-body');
        const itemModal = document.getElementById('item-modal');
        const itemForm = document.getElementById('item-form');
        const categoryModal = document.getElementById('category-modal');
        const categoryForm = document.getElementById('category-form');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                listenForCategories();
                listenForStockItems();
            } else {
                window.location.href = './index.html';
            }
        });

        function listenForCategories() {
            const categoriesRef = collection(db, "businesses", currentUser.uid, "stock_categories");
            const q = query(categoriesRef, orderBy("name"));
            onSnapshot(q, (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCategoryDropdowns();
                renderCategoryList();
            });
        }

        function populateCategoryDropdowns() {
            const selects = [document.getElementById('item-category'), categoryFilter];
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                if (select.id === 'category-filter') {
                    select.add(new Option('Todas as Categorias', 'all'));
                }
                allCategories.forEach(cat => select.add(new Option(cat.name, cat.id)));
                select.value = currentValue;
            });
        }

        function renderCategoryList() {
            const listEl = document.getElementById('category-list');
            listEl.innerHTML = '';
            allCategories.forEach(cat => {
                const catEl = document.createElement('div');
                catEl.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                catEl.innerHTML = `<span>${cat.name}</span>
                    <div class="flex gap-1">
                        <button class="edit-cat-btn p-1 hover:text-blue-600" data-id="${cat.id}" data-name="${cat.name}"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button class="delete-cat-btn p-1 hover:text-red-600" data-id="${cat.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                listEl.appendChild(catEl);
            });
            lucide.createIcons();
        }
        
        document.getElementById('manage-categories-btn').addEventListener('click', () => categoryModal.classList.remove('hidden'));
        document.getElementById('close-category-modal-btn').addEventListener('click', () => categoryModal.classList.add('hidden'));

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('category-id-input').value;
            const name = document.getElementById('category-name-input').value;
            if (!name) return;
            const categoriesRef = collection(db, "businesses", currentUser.uid, "stock_categories");
            try {
                if (id) {
                    await updateDoc(doc(categoriesRef, id), { name });
                    showNotification('Categoria atualizada!', 'success');
                } else {
                    await addDoc(categoriesRef, { name });
                    showNotification('Categoria criada!', 'success');
                }
                categoryForm.reset();
                document.getElementById('category-id-input').value = '';
            } catch (error) { showNotification('Erro ao salvar categoria.', 'error'); }
        });

        document.getElementById('category-list').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-cat-btn');
            if (editBtn) {
                document.getElementById('category-id-input').value = editBtn.dataset.id;
                document.getElementById('category-name-input').value = editBtn.dataset.name;
            }
            const deleteBtn = e.target.closest('.delete-cat-btn');
            if (deleteBtn) {
                if (await showConfirm('Excluir esta categoria? Os itens nela não serão excluídos.')) {
                    await deleteDoc(doc(db, "businesses", currentUser.uid, "stock_categories", deleteBtn.dataset.id));
                    showNotification('Categoria excluída.', 'info');
                }
            }
        });

        function listenForStockItems() {
            const itemsRef = collection(db, "businesses", currentUser.uid, "stock_items");
            const q = query(itemsRef, orderBy("name"));
            onSnapshot(q, (snapshot) => {
                allStockItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFiltersAndRender();
                checkAlerts();
            });
        }
        
        function applyFiltersAndRender() {
            let filteredItems = [...allStockItems];
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.code || '').toLowerCase().includes(searchTerm)
                );
            }
            const categoryId = categoryFilter.value;
            if (categoryId && categoryId !== 'all') {
                filteredItems = filteredItems.filter(item => item.categoryId === categoryId);
            }
            if (document.getElementById('expiry-filter-btn').classList.contains('bg-amber-200')) {
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                filteredItems = filteredItems.filter(item => item.expiry && new Date(item.expiry) <= thirtyDaysFromNow);
            }
            if (document.getElementById('restock-filter-btn').classList.contains('bg-red-200')) {
                filteredItems = filteredItems.filter(item => (item.quantity || 0) <= 5);
            }
            currentItemList = filteredItems;
            currentPage = 1;
            renderPaginatedTable();
        }
        
        [searchInput, categoryFilter].forEach(el => el.addEventListener('input', applyFiltersAndRender));
        document.getElementById('expiry-filter-btn').addEventListener('click', (e) => { e.currentTarget.classList.toggle('bg-amber-200'); applyFiltersAndRender(); });
        document.getElementById('restock-filter-btn').addEventListener('click', (e) => { e.currentTarget.classList.toggle('bg-red-200'); applyFiltersAndRender(); });

        function renderPaginatedTable() {
            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.innerHTML = '';
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedItems = currentItemList.slice(startIndex, endIndex);
            renderTable(paginatedItems);
            const totalPages = Math.ceil(currentItemList.length / ITEMS_PER_PAGE);
            if (totalPages > 1) {
                const prev = document.createElement('button'); prev.innerHTML = '<i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Voltar'; prev.className = 'px-4 py-2 flex items-center disabled:opacity-50'; prev.disabled = currentPage === 1; prev.onclick = () => { currentPage--; renderPaginatedTable(); };
                const next = document.createElement('button'); next.innerHTML = 'Ver mais <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>'; next.className = 'px-4 py-2 flex items-center disabled:opacity-50'; next.disabled = currentPage >= totalPages; next.onclick = () => { currentPage++; renderPaginatedTable(); };
                const pageInfo = document.createElement('span'); pageInfo.textContent = `Página ${currentPage} de ${totalPages}`; pageInfo.className = 'text-sm text-gray-600';
                paginationControls.append(prev, pageInfo, next);
                lucide.createIcons();
            }
        }
        
        function renderTable(itemsToRender) {
            tableBody.innerHTML = '';
            if (itemsToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Nenhum item encontrado.</td></tr>';
                return;
            }
            const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);

            itemsToRender.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                const needsRestock = (item.quantity || 0) <= 5;
                const expiringSoon = item.expiry && new Date(item.expiry) <= thirtyDaysFromNow;
                let expiryClass = '';
                if(expiringSoon) expiryClass = 'text-amber-600 font-bold';
                const categoryName = allCategories.find(c => c.id === item.categoryId)?.name || 'Sem categoria';
                
                tr.innerHTML = `
                    <td class="p-3">${item.code || ''}</td>
                    <td class="p-3 font-semibold">${item.name} ${needsRestock ? '<i data-lucide="package-x" class="inline w-4 h-4 text-red-500"></i>' : ''}</td>
                    <td class="p-3 text-sm text-gray-600">${categoryName}</td>
                    <td class="p-3 ${expiryClass}">${item.expiry ? new Date(item.expiry + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td class="p-3 text-center font-bold ${needsRestock ? 'text-red-600' : ''}">${item.quantity}</td>
                    <td class="p-3">${(item.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="p-3 text-right">
                        <button class="edit-btn p-1" data-id="${item.id}"><i data-lucide="file-pen-line" class="w-5 h-5 pointer-events-none text-gray-500 hover:text-blue-600"></i></button>
                        <button class="delete-btn p-1" data-id="${item.id}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none text-gray-500 hover:text-red-600"></i></button>
                    </td>`;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        document.getElementById('add-item-btn').addEventListener('click', () => {
            itemModal.querySelector('#item-modal-title').textContent = 'Cadastrar Novo Item';
            itemForm.reset();
            itemForm.querySelector('#item-id').value = '';
            itemModal.classList.remove('hidden');
        });

        tableBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                const item = allStockItems.find(i => i.id === editBtn.dataset.id);
                if(item) {
                    itemForm.querySelector('#item-id').value = item.id;
                    itemForm.querySelector('#item-code').value = item.code || '';
                    itemForm.querySelector('#item-name').value = item.name || '';
                    itemForm.querySelector('#item-price').value = (item.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    itemForm.querySelector('#item-expiry').value = item.expiry || '';
                    itemForm.querySelector('#item-quantity').value = item.quantity || 0;
                    itemForm.querySelector('#item-category').value = item.categoryId || '';
                    itemModal.querySelector('#item-modal-title').textContent = 'Editar Item';
                    itemModal.classList.remove('hidden');
                }
            }
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                handleDeleteItem(deleteBtn.dataset.id);
            }
        });

        async function handleDeleteItem(itemId) {
            if (await showConfirm('Tem certeza que deseja excluir este item?')) {
                try {
                    await deleteDoc(doc(db, "businesses", currentUser.uid, "stock_items", itemId));
                    showNotification('Item excluído com sucesso!', 'success');
                } catch (error) { showNotification('Erro ao excluir item.', 'error'); }
            }
        }
        
        document.getElementById('cancel-btn').addEventListener('click', () => itemModal.classList.add('hidden'));
        
        itemForm.querySelector('#item-price').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value ? (parseInt(value, 10) / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '';
        });
        
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = itemForm.querySelector('#item-id').value;
            const priceString = itemForm.querySelector('#item-price').value.replace(/\D/g, '');
            const itemData = {
                code: itemForm.querySelector('#item-code').value,
                name: itemForm.querySelector('#item-name').value,
                categoryId: itemForm.querySelector('#item-category').value,
                price: priceString ? parseInt(priceString) / 100 : 0,
                expiry: itemForm.querySelector('#item-expiry').value,
                quantity: parseInt(itemForm.querySelector('#item-quantity').value) || 0,
            };
            try {
                const itemsRef = collection(db, "businesses", currentUser.uid, "stock_items");
                if (id) {
                    await updateDoc(doc(itemsRef, id), itemData);
                    showNotification("Item atualizado!", 'success');
                } else {
                    await addDoc(itemsRef, itemData);
                    showNotification("Item salvo!", 'success');
                }
                itemModal.classList.add('hidden');
            } catch (error) { showNotification("Erro ao salvar.", 'error'); }
        });

        function checkAlerts() {
            const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
            const expiringCount = allStockItems.filter(item => item.expiry && new Date(item.expiry) <= thirtyDaysFromNow).length;
            const restockCount = allStockItems.filter(item => (item.quantity || 0) <= 5).length;
            const alertsPanel = document.getElementById('alerts-panel');
            alertsPanel.innerHTML = '';
            if (expiringCount > 0) alertsPanel.innerHTML += `<div class="notification-alert bg-amber-100 text-amber-800 text-sm font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2"><i data-lucide="calendar-clock"></i>${expiringCount} item(ns) com validade próxima!</div>`;
            if (restockCount > 0) alertsPanel.innerHTML += `<div class="notification-alert bg-red-100 text-red-800 text-sm font-bold px-4 py-2 rounded-full shadow-lg flex items-center gap-2"><i data-lucide="package-x"></i>${restockCount} item(ns) precisando de reposição!</div>`;
            lucide.createIcons();
        }

        document.getElementById('share-btn').addEventListener('click', () => {
            if (!currentUser) return;
            // CORREÇÃO: Garante que a URL seja construída corretamente, removendo o nome do arquivo atual.
            const path = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            const orderLink = `${window.location.origin}${path}/pedido.html?businessId=${currentUser.uid}`;
            const message = `Olá! 😊\n\nFaça seu pedido através do nosso cardápio digital:\n${orderLink}`;
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile && navigator.share) {
                navigator.share({
                    title: 'Faça seu Pedido',
                    text: message,
                }).catch(err => {
                    // Ignora o erro se o usuário simplesmente fechar a janela de compartilhamento
                    if (err.name !== 'AbortError') {
                        console.error("Erro ao usar navigator.share:", err);
                        // Fallback para o WhatsApp Web se o share API falhar por outro motivo
                        window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
                    }
                });
            } else {
                // Link direto para o WhatsApp Web para desktops
                const whatsappUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
        });
    </script>
</body>
</html>




