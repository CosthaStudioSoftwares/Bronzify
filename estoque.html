<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
        if (sessionStorage.getItem('acessoLiberado') !== 'true') {
            window.location.href = 'dashboard.html';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        /* Para garantir que a tabela não quebre em telas pequenas */
        tbody tr:hover { background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex items-center">
                    <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                    <h2 class="text-3xl lg:text-4xl text-gray-800 ml-2 sm:ml-0">Controle de Estoque</h2>
                </div>
                <button id="add-item-btn" class="w-full sm:w-auto bg-[#B76E79] text-white px-4 py-2 rounded-lg hover:opacity-90 flex items-center justify-center gap-2">
                    <i data-lucide="plus"></i> <span>Cadastrar Item</span>
                </button>
            </header>

            <div class="bg-white p-6 rounded-2xl shadow-md">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="p-3">Código</th>
                                <th class="p-3">Nome do Produto</th>
                                <th class="p-3">Validade</th>
                                <th class="p-3 text-center">Qtd.</th>
                                <th class="p-3">Valor Unitário</th>
                                <th class="p-3 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8">
            <h3 id="item-modal-title" class="text-2xl text-gray-800 mb-6">Cadastrar Novo Item</h3>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="item-code" class="block text-gray-600 mb-2">Código do Produto</label>
                        <input type="text" id="item-code" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79]">
                    </div>
                    <div>
                        <label for="item-name" class="block text-gray-600 mb-2">Nome do Produto</label>
                        <input type="text" id="item-name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79]" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="item-price" class="block text-gray-600 mb-2">Valor</label>
                        <input type="text" id="item-price" placeholder="R$ 0,00" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79]" required>
                    </div>
                    <div>
                        <label for="item-expiry" class="block text-gray-600 mb-2">Validade</label>
                        <input type="date" id="item-expiry" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79]">
                    </div>
                    <div>
                        <label for="item-quantity" class="block text-gray-600 mb-2">Quantidade</label>
                        <input type="number" id="item-quantity" value="1" min="0" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#B76E79]" required>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-btn" class="px-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-[#B76E79] text-white rounded-lg hover:opacity-90">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>lucide.createIcons();</script>
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allStockItems = [];

        const tableBody = document.getElementById('stock-table-body');
        const modal = document.getElementById('item-modal');
        const form = document.getElementById('item-form');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                listenForStockItems();
            } else {
                window.location.href = './index.html';
            }
        });

        function listenForStockItems() {
            const itemsRef = collection(db, "businesses", currentUser.uid, "stock_items");
            const q = query(itemsRef, orderBy("name"));
            onSnapshot(q, (snapshot) => {
                allStockItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable();
            });
        }

        function renderTable() {
            tableBody.innerHTML = '';
            if (allStockItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhum item cadastrado no estoque.</td></tr>';
                return;
            }
            allStockItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                
                const formattedPrice = (item.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const formattedDate = item.expiry ? new Date(item.expiry + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';

                tr.innerHTML = `
                    <td class="p-3">${item.code || ''}</td>
                    <td class="p-3 font-semibold">${item.name}</td>
                    <td class="p-3">${formattedDate}</td>
                    <td class="p-3 text-center">${item.quantity}</td>
                    <td class="p-3">${formattedPrice}</td>
                    <td class="p-3 text-right">
                        <button class="edit-btn p-1 text-gray-500 hover:text-blue-600" data-id="${item.id}"><i data-lucide="file-pen-line" class="w-5 h-5 pointer-events-none"></i></button>
                        <button class="delete-btn p-1 text-gray-500 hover:text-red-600" data-id="${item.id}"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        document.getElementById('add-item-btn').addEventListener('click', () => {
            form.reset();
            form.querySelector('#item-id').value = '';
            modal.querySelector('#item-modal-title').textContent = 'Cadastrar Novo Item';
            modal.classList.remove('hidden');
        });

        tableBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                const itemId = editBtn.dataset.id;
                const item = allStockItems.find(i => i.id === itemId);
                if(item) {
                    form.querySelector('#item-id').value = item.id;
                    form.querySelector('#item-code').value = item.code || '';
                    form.querySelector('#item-name').value = item.name || '';
                    form.querySelector('#item-price').value = (item.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    form.querySelector('#item-expiry').value = item.expiry || '';
                    form.querySelector('#item-quantity').value = item.quantity || 0;
                    modal.querySelector('#item-modal-title').textContent = 'Editar Item';
                    modal.classList.remove('hidden');
                }
            }
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                handleDelete(deleteBtn.dataset.id);
            }
        });

        async function handleDelete(itemId) {
            const confirmed = await showConfirm('Tem certeza que deseja excluir este item?');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "businesses", currentUser.uid, "stock_items", itemId));
                    showNotification('Item excluído com sucesso!', 'success');
                } catch (error) {
                    showNotification('Erro ao excluir item.', 'error');
                    console.error("Erro:", error);
                }
            }
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = form.querySelector('#item-id').value;
            const priceString = form.querySelector('#item-price').value.replace(/\D/g, '');
            
            const itemData = {
                code: form.querySelector('#item-code').value,
                name: form.querySelector('#item-name').value,
                price: priceString ? parseInt(priceString) / 100 : 0,
                expiry: form.querySelector('#item-expiry').value,
                quantity: parseInt(form.querySelector('#item-quantity').value) || 0,
            };

            try {
                if (itemId) {
                    await updateDoc(doc(db, "businesses", currentUser.uid, "stock_items", itemId), itemData);
                    showNotification('Item atualizado com sucesso!', 'success');
                } else {
                    await addDoc(collection(db, "businesses", currentUser.uid, "stock_items"), itemData);
                    showNotification('Item cadastrado com sucesso!', 'success');
                }
                modal.classList.add('hidden');
            } catch (error) {
                showNotification('Erro ao salvar o item.', 'error');
                console.error("Erro:", error);
            }
        });

        form.querySelector('#item-price').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value ? (parseInt(value, 10) / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '';
        });

        document.getElementById('cancel-btn').addEventListener('click', () => modal.classList.add('hidden'));

    </script>
</body>
</html>