<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
        if (sessionStorage.getItem('acessoLiberado') !== 'true') {
            window.location.href = 'dashboard.html';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .notification-badge { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .quantity-input { -moz-appearance: textfield; }
        #main-content-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(249, 250, 251, 0.8);
            backdrop-filter: blur(4px);
            z-index: 40;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-4">
                    <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                    <h2 class="text-3xl lg:text-4xl text-gray-800">Frente de Caixa</h2>
                    <div class="hidden lg:flex items-center gap-2 border-l pl-4 ml-4">
                        <button id="cash-flow-btn" class="flex items-center gap-2 p-2 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-lg">
                           <i data-lucide="arrow-right-left" class="w-4 h-4"></i> <span>Abertura/Fechamento</span>
                       </button>
                       <button id="show-daily-sales-btn" class="flex items-center gap-2 p-2 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-lg">
                           <i data-lucide="history" class="w-4 h-4"></i> <span>Atendimentos do Dia</span>
                       </button>
                    </div>
                </div>
                <div class="relative">
                    <button id="incoming-orders-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <i data-lucide="bell" class="w-6 h-6 text-gray-700"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </header>
            
            <div class="relative">
                <div id="main-content-overlay" class="flex items-center justify-center rounded-2xl">
                    <div class="text-center">
                        <i data-lucide="lock" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4 font-semibold text-gray-600">O caixa está fechado. Clique em "Abertura/Fechamento" para começar.</p>
                    </div>
                </div>
                <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-2xl text-gray-800 mb-4">1. Selecionar Cliente</h3>
                            <div class="relative"><input type="text" id="client-search" placeholder="Digite o nome ou telefone da cliente..." class="w-full p-2 border rounded-lg"><div id="search-results" class="absolute z-40 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg"></div></div>
                            <div id="selected-client-display" class="mt-4 hidden items-center gap-3 bg-rose-50 p-3 rounded-lg"><p class="font-semibold text-gray-700">Cliente: <span id="selected-client-name"></span></p><div id="birthday-alert" class="hidden items-center gap-1 text-sm text-pink-600 font-semibold"><i data-lucide="cake" class="w-4 h-4"></i><span>Aniversariante do mês!</span></div></div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-2xl text-gray-800 mb-4">2. Serviços e Produtos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="space-y-6">
                                    <div><label class="font-semibold text-gray-700">Tipos de Bronze</label><div class="relative mt-1"><input type="text" id="bronze-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg"><div id="bronze-search-results" class="absolute z-30 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div></div><div id="selected-bronze-items" class="mt-3 space-y-2"></div></div>
                                    <div><label class="font-semibold text-gray-700">Adicionais</label><div class="relative mt-1"><input type="text" id="extra-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg"><div id="extra-search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div></div><div id="selected-extra-items" class="mt-3 space-y-2"></div></div>
                                </div>
                                <div class="space-y-6">
                                    <div><label class="font-semibold text-gray-700">Consumo</label><div class="relative mt-1"><input type="text" id="consumable-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg"><div id="consumable-search-results" class="absolute z-20 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div></div><div id="selected-consumable-items" class="mt-3 space-y-2"></div></div>
                                     <div><label class="font-semibold text-gray-700">Estoque</label><div class="relative mt-1"><input type="text" id="stock-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg"><div id="stock-search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div></div><div id="selected-stock-items" class="mt-3 space-y-2"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-2xl shadow-md lg:sticky top-8">
                            <h3 class="text-2xl text-gray-800 mb-4">3. Resumo da Venda</h3>
                            <div id="order-details" class="hidden mb-4 p-3 bg-blue-50 border rounded-lg"><p class="text-sm font-semibold text-blue-800">Pedido online carregado.</p></div>
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                                <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span>Desconto</span><div class="flex border rounded-md text-xs"><button id="discount-type-value" class="px-2 py-1 bg-rose-100 text-rose-700 rounded-l-md">R$</button><button id="discount-type-percent" class="px-2 py-1 bg-gray-100 text-gray-500 rounded-r-md">%</button></div></div><input type="text" id="discount-input" placeholder="0,00" class="w-24 p-1 border rounded-md text-right"></div>
                                <div class="flex justify-between text-sm pr-1"><span>&nbsp;</span><span id="discount-applied">- R$ 0,00</span></div>
                                <hr>
                                <div class="flex justify-between font-bold text-xl"><span>TOTAL</span><span id="total">R$ 0,00</span></div>
                            </div>
                            <h4 class="font-semibold text-gray-600 mb-2">Forma de Pagamento</h4>
                            <select id="payment-method" class="w-full p-2 border rounded-lg mb-4"><option>Dinheiro</option><option>PIX</option><option>Débito</option><option>Crédito</option><option>A Prazo</option><option>Parceria</option></select>
                            <button id="save-sale-btn" class="w-full bg-gradient-to-r from-pink-500 to-[#B76E79] text-white py-3 rounded-lg font-bold text-lg">Salvar Venda</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="cash-flow-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8">
            <h3 class="text-2xl text-gray-800 mb-2">Abertura / Fechamento de Caixa</h3>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex gap-6" aria-label="Tabs">
                    <button id="tab-control" class="tab-btn border-b-2 border-[#B76E79] text-[#B76E79] py-4 px-1 text-sm font-medium">Controle</button>
                    <button id="tab-history" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">Histórico</button>
                </nav>
            </div>
            <div id="control-panel" class="mt-6"></div>
            <div id="history-panel" class="mt-6 hidden">
                <div class="flex gap-4 items-end">
                    <div class="flex-grow"><label for="history-date" class="block text-gray-600 mb-1">Pesquisar por Data</label><input type="date" id="history-date" class="w-full p-2 border rounded-lg"></div>
                    <button id="search-history-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Buscar</button>
                </div>
                <div id="history-results" class="mt-4 space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
            <button type="button" id="close-cash-flow-modal" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <h3 class="text-2xl text-gray-800 mb-4">Relatório de Fechamento</h3>
            <div id="report-content-modal" class="text-gray-700 space-y-2"></div>
            <div class="flex gap-4 mt-6">
                <button id="download-report-btn" class="w-full flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Baixar PDF</button>
                <button id="close-report-modal" class="w-full flex-1 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
            </div>
        </div>
    </div>
    <div id="incoming-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8">
            <h3 class="text-2xl text-gray-800 mb-6">Pedidos Online Pendentes</h3>
            <div id="incoming-orders-list" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
            <button id="close-orders-modal-btn" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    <div id="password-qr-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 text-center">
            <h3 class="text-2xl text-gray-800 mb-2">Venda Concluída!</h3>
            <p class="text-gray-600">A senha da cliente é:</p><p id="modal-password" class="text-7xl font-bold text-[#B76E79] my-4"></p>
            <p class="text-gray-600 mb-4">Peça para a cliente escanear o QR Code abaixo.</p>
            <div id="qrcode-container" class="flex justify-center items-center p-4 border rounded-lg"></div>
            <button id="close-qr-modal-btn" class="w-full mt-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Fechar</button>
        </div>
    </div>
    <div id="daily-sales-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8">
            <h3 class="text-2xl text-gray-800 mb-6">Atendimentos do Dia</h3>
            <div class="overflow-y-auto max-h-[70vh]">
                <table class="w-full text-left">
                    <thead><tr class="border-b"><th class="p-2">Senha</th><th class="p-2">Cliente</th><th class="p-2">Horário</th><th class="p-2">Valor</th><th class="p-2">Pagamento</th><th class="p-2">Ações</th></tr></thead>
                    <tbody id="daily-sales-table"></tbody>
                </table>
            </div>
            <button id="close-daily-sales-btn" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    <div id="cancellation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <h3 class="text-2xl text-gray-800 mb-4">Cancelar Venda</h3>
            <p class="text-gray-600 mb-4">Por favor, informe o motivo do cancelamento.</p>
            <form id="cancellation-form">
                <input type="hidden" id="cancellation-sale-id">
                <textarea id="cancellation-reason" class="w-full p-2 border rounded-lg" rows="3" required></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-cancellation-btn" class="px-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Voltar</button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar Cancelamento</button>
                </div>
            </form>
        </div>
    </div>

    <script>lucide.createIcons();</script>
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot, getDocs, where, Timestamp, increment, writeBatch, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variáveis Globais ---
        let currentUser = null, selectedClient = null, loadedOnlineOrder = null, synth = null, editingSaleId = null, discountType = 'value';
        let allClients = [], allProducts = [], allStockItems = [], pendingOrders = [], dailySales = [];
        let selectedItems = new Map();
        
        const ui = {
            clientSearch: document.getElementById('client-search'), searchResults: document.getElementById('search-results'),
            bronzeSearch: document.getElementById('bronze-search'), bronzeSearchResults: document.getElementById('bronze-search-results'),
            consumableSearch: document.getElementById('consumable-search'), consumableSearchResults: document.getElementById('consumable-search-results'),
            stockSearch: document.getElementById('stock-search'), stockSearchResults: document.getElementById('stock-search-results'),
            extraSearch: document.getElementById('extra-search'), extraSearchResults: document.getElementById('extra-search-results'),
            selectedBronzeItems: document.getElementById('selected-bronze-items'),
            selectedConsumableItems: document.getElementById('selected-consumable-items'),
            selectedStockItems: document.getElementById('selected-stock-items'),
            selectedExtraItems: document.getElementById('selected-extra-items'),
            subtotal: document.getElementById('subtotal'), discountInput: document.getElementById('discount-input'),
            discountApplied: document.getElementById('discount-applied'), total: document.getElementById('total'),
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkCashRegisterStatus();
                loadInitialData();
                document.body.addEventListener('click', async () => { if (!synth) { await Tone.start(); synth = new Tone.Synth().toDestination(); }}, { once: true });
            } else { window.location.href = 'index.html'; }
        });

        async function loadInitialData() {
            const clientsRef = collection(db, "businesses", currentUser.uid, "clients");
            const productsRef = collection(db, "businesses", currentUser.uid, "products");
            const stockItemsRef = collection(db, "businesses", currentUser.uid, "stock_items");
            const [clientsSnap, productsSnap, stockItemsSnap] = await Promise.all([ getDocs(clientsRef), getDocs(query(productsRef, orderBy("name"))), getDocs(query(stockItemsRef, orderBy("name"))) ]);
            allClients = clientsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allProducts = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allStockItems = stockItemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'stock' }));
            listenForIncomingOrders();
            listenForDailySales();
        }

        const cashFlowModal = document.getElementById('cash-flow-modal');
        const mainContentOverlay = document.getElementById('main-content-overlay');
        function checkCashRegisterStatus() {
            const cashRegister = JSON.parse(sessionStorage.getItem('cashRegister'));
            if (cashRegister && cashRegister.status === 'open') mainContentOverlay.classList.add('hidden');
            else mainContentOverlay.classList.remove('hidden');
        }
        document.getElementById('cash-flow-btn').addEventListener('click', () => { renderControlPanel(); cashFlowModal.classList.remove('hidden'); });
        document.getElementById('close-cash-flow-modal').addEventListener('click', () => cashFlowModal.classList.add('hidden'));
        document.getElementById('tab-control').addEventListener('click', (e) => {
            document.getElementById('control-panel').classList.remove('hidden'); document.getElementById('history-panel').classList.add('hidden');
            e.target.classList.add('border-[#B76E79]', 'text-[#B76E79]');
            document.getElementById('tab-history').classList.remove('border-transparent', 'text-gray-500');
        });
        document.getElementById('tab-history').addEventListener('click', (e) => {
            document.getElementById('control-panel').classList.add('hidden'); document.getElementById('history-panel').classList.remove('hidden');
            e.target.classList.add('border-[#B76E79]', 'text-[#B76E79]');
            document.getElementById('tab-control').classList.remove('border-[#B76E79]', 'text-[#B76E79]');
        });
        
        function renderControlPanel() {
            const controlPanel = document.getElementById('control-panel');
            const cashRegister = JSON.parse(sessionStorage.getItem('cashRegister'));
            if (cashRegister && cashRegister.status === 'open') {
                controlPanel.innerHTML = `<p class="mb-4">Caixa aberto por: <span class="font-bold">${cashRegister.operatorName}</span></p><button id="close-cash-btn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Fechar Caixa</button>`;
                document.getElementById('close-cash-btn').addEventListener('click', handleCloseCash);
            } else {
                controlPanel.innerHTML = `<form id="open-cash-form" class="space-y-4"><div><label for="operator-name">Seu Nome</label><input type="text" id="operator-name" class="w-full p-2 border rounded-lg mt-1" required></div><div><label for="initial-change">Valor de Troco Inicial</label><input type="text" id="initial-change" class="w-full p-2 border rounded-lg mt-1" placeholder="R$ 0,00" required></div><button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Abrir Caixa</button></form>`;
                document.getElementById('initial-change').addEventListener('input', (e) => { let v = e.target.value.replace(/\D/g, ''); e.target.value = v ? (parseInt(v) / 100).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : ''; });
                document.getElementById('open-cash-form').addEventListener('submit', handleOpenCash);
            }
        }
        async function handleOpenCash(e) {
            e.preventDefault();
            const operatorName = document.getElementById('operator-name').value;
            const initialChange = parseFloat(document.getElementById('initial-change').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            const newShift = { operatorName, initialChange, openTime: Timestamp.now(), status: 'open' };
            try {
                const shiftRef = doc(collection(db, "businesses", currentUser.uid, "cash_shifts"));
                await setDoc(shiftRef, newShift);
                sessionStorage.setItem('cashRegister', JSON.stringify({ ...newShift, shiftId: shiftRef.id, openTime: newShift.openTime.toMillis() }));
                showNotification('Caixa aberto com sucesso!', 'success');
                cashFlowModal.classList.add('hidden');
                checkCashRegisterStatus();
            } catch (error) { console.error("Erro ao abrir caixa:", error); showNotification('Erro ao abrir caixa.', 'error'); }
        }
        async function handleCloseCash() {
             const patioSalesRef = query(collection(db, "businesses", currentUser.uid, "sales"), where("status", "==", "called"));
             const patioSnapshot = await getDocs(patioSalesRef);
             if (!patioSnapshot.empty) {
                if(!await showConfirm(`Atenção: ${patioSnapshot.size} cliente(s) ainda estão no pátio. Deseja mesmo fechar o caixa?`, 'Confirmar Fechamento', 'Sim, Fechar Mesmo Assim')) return;
             }
             if (!await showConfirm('Deseja realmente fechar o caixa agora?', 'Confirmar Fechamento', 'Sim, Fechar')) return;
             const cashRegister = JSON.parse(sessionStorage.getItem('cashRegister'));
             const openTime = new Date(cashRegister.openTime);
             const salesRef = query(collection(db, "businesses", currentUser.uid, "sales"), where("createdAt", ">=", openTime));
             const salesSnapshot = await getDocs(salesRef);
             let totalClients = 0; const paymentTotals = {};
             salesSnapshot.forEach(doc => {
                const sale = doc.data();
                if(sale.status !== 'cancelled') {
                    totalClients++;
                    const method = sale.paymentMethod || 'N/A';
                    paymentTotals[method] = (paymentTotals[method] || 0) + sale.total;
                }
             });
             const reportData = { ...cashRegister, closeTime: Timestamp.now(), totalClients, paymentTotals, status: 'closed' };
             try {
                await updateDoc(doc(db, "businesses", currentUser.uid, "cash_shifts", cashRegister.shiftId), reportData);
                sessionStorage.removeItem('cashRegister');
                showNotification('Caixa fechado com sucesso!', 'info');
                cashFlowModal.classList.add('hidden');
                checkCashRegisterStatus();
                displayReportModal(reportData);
             } catch (error) { console.error("Erro ao fechar caixa:", error); showNotification('Erro ao fechar o caixa.', 'error'); }
        }
        function displayReportModal(report) {
            const contentEl = document.getElementById('report-content-modal');
            let paymentHtml = '';
            for (const [method, total] of Object.entries(report.paymentTotals || {})) {
                paymentHtml += `<div class="flex justify-between"><span>${method}:</span><span class="font-semibold">${total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div>`;
            }
            const totalCash = (report.paymentTotals?.['Dinheiro'] || 0) + (report.initialChange || 0);
            contentEl.innerHTML = `<p><strong>Operador:</strong> ${report.operatorName}</p><p><strong>Abertura:</strong> ${report.openTime.toDate().toLocaleString('pt-BR')}</p><p><strong>Fechamento:</strong> ${report.closeTime.toDate().toLocaleString('pt-BR')}</p><hr class="my-2"><p><strong>Total de Atendimentos:</strong> ${report.totalClients}</p><div class="mt-2 border-t pt-2">${paymentHtml}</div><hr class="my-2"><div class="flex justify-between"><span>Troco Inicial:</span><span>${(report.initialChange || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div><div class="flex justify-between text-lg font-bold mt-2"><span>Total em Caixa (Dinheiro):</span><span>${totalCash.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div>`;
            document.getElementById('report-modal').classList.remove('hidden');
            document.getElementById('close-report-modal').onclick = () => document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('download-report-btn').onclick = () => generateReportPDF(report);
        }
        function generateReportPDF(report) {
             const { jsPDF } = window.jspdf;
             const pdf = new jsPDF();
             pdf.setFontSize(18); pdf.text("Relatório de Fechamento de Caixa", 14, 22);
             pdf.setFontSize(11); pdf.setTextColor(100);
             pdf.text(`Operador: ${report.operatorName}`, 14, 30);
             pdf.text(`Abertura: ${report.openTime.toDate().toLocaleString('pt-BR')}`, 14, 36);
             pdf.text(`Fechamento: ${report.closeTime.toDate().toLocaleString('pt-BR')}`, 14, 42);
             
             const body = [
                ['Total de Atendimentos', report.totalClients.toString()],
                ...Object.entries(report.paymentTotals || {}).map(([method, total]) => [method, total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})]),
                ['Troco Inicial', (report.initialChange || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})],
                ['Total em Caixa (Dinheiro)', ((report.paymentTotals?.['Dinheiro'] || 0) + (report.initialChange || 0)).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})]
             ];
             pdf.autoTable({ head: [['Descrição', 'Valor']], body, startY: 50, headStyles: {fillColor: [183,110,121]} });
             pdf.save(`fechamento_caixa_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        }
        document.getElementById('search-history-btn').addEventListener('click', async () => {
            const date = document.getElementById('history-date').value;
            if (!date) { showNotification("Por favor, selecione uma data.", "info"); return; }
            const startOfDay = new Date(date + 'T00:00:00');
            const endOfDay = new Date(date + 'T23:59:59');
            const historyRef = collection(db, "businesses", currentUser.uid, "cash_shifts");
            const q = query(historyRef, where("openTime", ">=", startOfDay), where("openTime", "<=", endOfDay), where("status", "==", "closed"), orderBy("openTime", "desc"));
            const snapshot = await getDocs(q);
            const resultsEl = document.getElementById('history-results');
            resultsEl.innerHTML = '';
            if (snapshot.empty) {
                resultsEl.innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum fechamento encontrado para esta data.</p>';
                return;
            }
            snapshot.docs.forEach(doc => {
                const shift = {id: doc.id, ...doc.data()};
                const shiftEl = document.createElement('div');
                shiftEl.className = 'p-3 bg-gray-100 rounded-lg flex justify-between items-center';
                shiftEl.innerHTML = `<div><p class="font-semibold">${shift.operatorName}</p><p class="text-xs text-gray-600">Aberto em: ${shift.openTime.toDate().toLocaleTimeString('pt-BR')}</p></div><button class="view-report-btn bg-white border rounded-lg px-3 py-1 text-sm" data-shift-id="${shift.id}">Ver Relatório</button>`;
                resultsEl.appendChild(shiftEl);
            });
        });
        document.getElementById('history-results').addEventListener('click', async (e) => {
            if(e.target.classList.contains('view-report-btn')) {
                const shiftId = e.target.dataset.shiftId;
                const shiftDoc = await getDoc(doc(db, "businesses", currentUser.uid, "cash_shifts", shiftId));
                if (shiftDoc.exists()) {
                    displayReportModal(shiftDoc.data());
                }
            }
        });
        
        // --- LÓGICA DE BUSCA E SELEÇÃO ---
        function handleSearch(e){const t=e.target,n=t.value.trim().toLowerCase();let l,a,c=t.id;switch(c){case"client-search":a=ui.searchResults,n.length<2?(a.classList.add("hidden"),0):l=allClients.filter(e=>(e.name||"").toLowerCase().includes(n)||e.phone&&e.phone.includes(n));break;case"bronze-search":a=ui.bronzeSearchResults,l=allProducts.filter(e=>"bronze"===e.category&&e.name.toLowerCase().includes(n));break;case"consumable-search":a=ui.consumableSearchResults,l=allProducts.filter(e=>"consumable"===e.category&&e.name.toLowerCase().includes(n));break;case"stock-search":a=ui.stockSearchResults,l=allStockItems.filter(e=>e.name.toLowerCase().includes(n));break;case"extra-search":a=ui.extraSearchResults,l=allProducts.filter(e=>"extra"===e.category&&e.name.toLowerCase().includes(n))}renderSearchResults(l,a,c)}function renderSearchResults(e,t,n){t.innerHTML="",0===e.length?t.innerHTML=`<div class="p-3 text-gray-500">${"client-search"===n?"Nenhum cliente.":"Nenhum item."}</div>`:e.slice(0,5).forEach(l=>{const a=document.createElement("div");a.className="p-3 hover:bg-gray-100 cursor-pointer","client-search"===n?(a.textContent=`${l.name} - ${l.phone}`,a.onclick=()=>selectClient(l)):(a.innerHTML=`<div class="flex justify-between"><span>${l.name}</span><span class="font-semibold">${(l.price||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</span></div>`,a.onclick=()=>addItemToSale(l)),t.appendChild(a)}),t.classList.remove("hidden")}async function addItemToSale(e){let t=!1;if("bronze"===e.category){if(selectedClient){const n=selectedClient.packages?.[e.name]||0;if(n>0&&await showConfirm(`Esta cliente tem ${n} sessão(ões) de ${e.name}. Deseja usar uma agora?`,"Usar Pacote?","Sim, Usar")){const n=`${e.id}-usage-${Date.now()}`;return selectedItems.set(n,{id:e.id,name:`${e.name} (Uso de Pacote)`,price:0,quantity:1,isPackage:!1,isPackageUsage:!0,type:"bronze"}),renderSelectedItems(),void calculateTotal()}}t=await showConfirm(`O serviço "${e.name}" é um pacote de 3 sessões?`,"Confirmar Pacote","Sim, é Pacote")}const n=t?`${e.id}-package`:e.id,l=e.type||e.category;selectedItems.has(n)&&("consumable"===l||"stock"===l)?selectedItems.get(n).quantity++:selectedItems.has(n)||(selectedItems.set(n,{id:e.id,name:t?`${e.name} (Pacote)`:e.name,price:t?3*e.price:e.price,quantity:1,isPackage:t,type:l,isPackageUsage:!1})),renderSelectedItems(),calculateTotal(),[ui.bronzeSearch,ui.consumableSearch,ui.stockSearch,ui.extraSearch].forEach(e=>e.value=""),document.querySelectorAll('[id$="-search-results"]').forEach(e=>e.classList.add("hidden"))}
        function renderSelectedItems(){ui.selectedBronzeItems.innerHTML="",ui.selectedConsumableItems.innerHTML="",ui.selectedStockItems.innerHTML="",ui.selectedExtraItems.innerHTML="";for(const[e,t]of selectedItems.entries()){const n=document.createElement("div");n.className="flex items-center justify-between p-2 bg-gray-100 rounded-lg";const l=(t.price*t.quantity).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});let a="";"consumable"!==t.type&&"stock"!==t.type||(a=`<input type="number" value="${t.quantity}" min="1" data-id="${e}" class="selected-quantity-input w-16 p-1 border rounded-md text-center">`),n.innerHTML=`<span>${t.name}</span>\n                    <div class="flex items-center gap-2">\n                        <span class="font-semibold">${l}</span>\n                        ${a}\n                        <button data-id="${e}" class="remove-item-btn text-red-500 hover:text-red-700"><i data-lucide="x-circle" class="w-4 h-4"></i></button>\n                    </div>`;let c;"bronze"===t.type?c=ui.selectedBronzeItems:"consumable"===t.type?c=ui.selectedConsumableItems:"stock"===t.type?c=ui.selectedStockItems:"extra"===t.type&&(c=ui.selectedExtraItems),c&&c.appendChild(n)}lucide.createIcons()}document.body.addEventListener("click",e=>{const t=e.target.closest(".remove-item-btn");t&&(selectedItems.delete(t.dataset.id),renderSelectedItems(),calculateTotal())}),document.body.addEventListener("input",e=>{const t=e.target.closest(".selected-quantity-input");if(t){const e=selectedItems.get(t.dataset.id);e&&(e.quantity=parseInt(t.value)||1,renderSelectedItems(),calculateTotal())}});
        function calculateTotal(){let e=0;for(const t of selectedItems.values())e+=t.price*t.quantity;ui.subtotal.textContent=e.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});let t=0;const n=parseFloat(ui.discountInput.value.replace(/[^0-9,]/g,"").replace(",","."))||0;"value"===discountType?t=n:t=e*(n/100),ui.discountApplied.textContent=`- ${t.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`,ui.total.textContent=(e-t).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
        function selectClient(e){selectedClient=e,ui.clientSearch.value=e.name,document.getElementById("search-results").classList.add("hidden"),document.getElementById("selected-client-name").textContent=e.name,document.getElementById("selected-client-display").style.display="flex";const t=document.getElementById("birthday-alert");e.birthdate?(new Date(e.birthdate+"T00:00:00").getMonth()===new Date().getMonth()?t.style.display="flex":t.style.display="none"):t.style.display="none",lucide.createIcons()}
        function listenForIncomingOrders(){const e=query(collection(db,"businesses",currentUser.uid,"incoming_orders"),where("status","==","pending"));onSnapshot(e,e=>{pendingOrders=e.docs.map(e=>({id:e.id,...e.data()}));const t=document.getElementById("notification-badge");pendingOrders.length>0?(t.textContent=pendingOrders.length,t.classList.remove("hidden"),e.docChanges().some(e=>"added"===e.type)&&synth&&synth.triggerAttackRelease("C5","8n")):t.classList.add("hidden")})}
        document.getElementById("incoming-orders-btn").addEventListener("click",()=>{const e=document.getElementById("incoming-orders-modal"),t=document.getElementById("incoming-orders-list");t.innerHTML="",0===pendingOrders.length?t.innerHTML='<p class="text-gray-500">Nenhum pedido pendente.</p>':pendingOrders.forEach(e=>{const n=document.createElement("div");n.className="p-4 border rounded-lg",n.innerHTML=`<div class="flex justify-between items-start"><div><p class="font-bold text-lg">${e.customerName}</p><p class="text-sm text-gray-600">${e.customerPhone}</p><p class="text-sm mt-2">Total: <span class="font-bold">${e.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</span></p></div><div class="flex gap-2"><button class="load-order-btn bg-green-500 text-white px-3 py-1 rounded" data-id="${e.id}">Carregar</button><button class="reject-order-btn bg-red-500 text-white px-3 py-1 rounded" data-id="${e.id}">Rejeitar</button></div></div>`,t.appendChild(n)}),e.classList.remove("hidden")}),document.getElementById("close-orders-modal-btn").addEventListener("click",()=>document.getElementById("incoming-orders-modal").classList.add("hidden"));
        document.getElementById("incoming-orders-list").addEventListener("click",async e=>{const t=e.target.dataset.id;if(t){const n=doc(db,"businesses",currentUser.uid,"incoming_orders",t);if(e.target.classList.contains("load-order-btn")){const e=pendingOrders.find(e=>e.id===t);e&&(resetSaleForm(),ui.clientSearch.value=e.customerName,e.items.forEach(e=>{const t=allStockItems.find(t=>t.name===e.name)||allProducts.find(t=>t.name===e.name)||allProducts.find(t=>`${t.name} (Pacote)`===e.name);if(t){const n=e.name.includes("(Pacote)"),l=n?`${t.id}-package`:t.id;selectedItems.set(l,{...t,name:e.name,quantity:e.quantity,price:e.price,type:t.type||t.category,isPackage:n})}}),document.getElementById("payment-method").value=e.paymentMethod,document.getElementById("order-details").classList.remove("hidden"),loadedOnlineOrder=e,renderSelectedItems(),calculateTotal(),document.getElementById("incoming-orders-modal").classList.add("hidden"),await updateDoc(n,{status:"loaded"}))}else e.target.classList.contains("reject-order-btn")&&await showConfirm("Rejeitar este pedido?")&&(await updateDoc(n,{status:"rejected"}),showNotification("Pedido rejeitado.","info"))}});
        document.getElementById('save-sale-btn').addEventListener('click',async()=>{const e=parseFloat(ui.total.textContent.replace(/[^\d,]/g,"").replace(",","."))||0,t=Array.from(selectedItems.values());if(0===t.length)return void showNotification("Nenhum item selecionado.","info");if(e<=0&&!t.some(e=>e.isPackageUsage))return void showNotification("O valor da venda não pode ser zero.","info");const n=editingSaleId?dailySales.find(e=>e.id===editingSaleId):null,l=editingSaleId?n.password:await getNextPassword(),a=editingSaleId?n.createdAt:Timestamp.now(),c={clientName:selectedClient?selectedClient.name:ui.clientSearch.value||"Cliente Avulso",clientId:selectedClient?selectedClient.id:null,total:e,subtotal:parseFloat(ui.subtotal.textContent.replace(/[^\d,]/g,"").replace(",","."))||0,discount:parseFloat(ui.discountApplied.textContent.replace(/[^\d,]/g,"").replace(",","."))||0,paymentMethod:document.getElementById("payment-method").value,items:t.map(e=>({name:e.name,price:e.price,quantity:e.quantity,isPackage:e.isPackage,isPackageUsage:e.isPackageUsage,type:e.type,id:e.id})),createdAt:a,status:"waiting",password:l};try{const e=writeBatch(db);if(selectedClient){const n=doc(db,"businesses",currentUser.uid,"clients",selectedClient.id),l={};t.forEach(e=>{e.isPackage&&(l[`packages.${e.name.replace(" (Pacote)","")}`]=increment(2)),e.isPackageUsage&&(l[`packages.${e.name.replace(" (Uso de Pacote)","")}`]=increment(-1))}),Object.keys(l).length>0&&e.update(n,l)}t.forEach(t=>{if("stock"===t.type){const n=doc(db,"businesses",currentUser.uid,"stock_items",t.id);e.update(n,{quantity:increment(-t.quantity)})}});const n=editingSaleId?doc(db,"businesses",currentUser.uid,"sales",editingSaleId):doc(collection(db,"businesses",currentUser.uid,"sales"));e.set(n,c,{merge:!0}),loadedOnlineOrder&&e.update(doc(db,"businesses",currentUser.uid,"incoming_orders",loadedOnlineOrder.id),{status:"completed"}),await e.commit(),editingSaleId||(document.getElementById("modal-password").textContent=l,document.getElementById("qrcode-container").innerHTML="",new QRCode(document.getElementById("qrcode-container"),{text:`${window.location.origin}${window.location.pathname.replace("caixa.html","status-cliente.html")}?businessId=${currentUser.uid}&id=${n.id}`,width:160,height:160}),document.getElementById("password-qr-modal").classList.remove("hidden")),showNotification(editingSaleId?"Venda atualizada!":"Venda salva!","success"),resetSaleForm()}catch(e){console.error(e),showNotification("Erro ao salvar a venda.","error")}});
        function resetSaleForm(){selectedClient=null,loadedOnlineOrder=null,editingSaleId=null,ui.clientSearch.value="",document.getElementById("selected-client-display").style.display="none",document.getElementById("order-details").classList.add("hidden"),selectedItems.clear(),renderSelectedItems(),calculateTotal(),document.getElementById("save-sale-btn").textContent="Salvar Venda"}
        async function getNextPassword(){const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,n=doc(db,"businesses",currentUser.uid,"dailyCounters",t),l=await getDoc(n);let a=l.exists()?l.data().lastPassword+1:1;return await setDoc(n,{lastPassword:a},{merge:!0}),String(a).padStart(3,"0")}
        function listenForDailySales(){const e=document.getElementById("daily-sales-table"),t=query(collection(db,"businesses",currentUser.uid,"sales"),where("createdAt",">=",new Date((new Date).setHours(0,0,0,0))),orderBy("createdAt","desc"));onSnapshot(t,t=>{dailySales=t.docs.map(e=>({id:e.id,...e.data()})),e.innerHTML="",t.empty?e.innerHTML='<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhuma venda hoje.</td></tr>':dailySales.forEach(t=>{const n=e.insertRow(),l="cancelled"===t.status;n.className=`border-b ${l?"bg-red-50 text-gray-400 line-through":"hover:bg-gray-50"}`,n.innerHTML=`<td class="p-2 font-mono">${t.password||"N/A"}</td><td class="p-2 font-semibold">${t.clientName} ${l?`<span class="text-xs text-red-600 font-normal block">(${t.cancellationReason||"Cancelado"})</span>`:""}</td><td class="p-2">${t.createdAt.toDate().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</td><td class="p-2">${(t.total||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td><td class="p-2">${t.paymentMethod}</td><td class="p-2 flex items-center gap-2"><button class="edit-sale-btn p-1 text-gray-500 hover:text-blue-600 ${l?"hidden":""}" data-id="${t.id}"><i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i></button><button class="delete-sale-btn p-1 text-gray-500 hover:text-red-600 ${l?"hidden":""}" data-id="${t.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></td>`}),lucide.createIcons()})}
        const dailySalesModal=document.getElementById("daily-sales-modal");document.getElementById("show-daily-sales-btn").addEventListener("click",()=>dailySalesModal.classList.remove("hidden")),document.getElementById("close-daily-sales-btn").addEventListener("click",()=>dailySalesModal.classList.add("hidden")),document.getElementById("close-qr-modal-btn").addEventListener("click",()=>document.getElementById("password-qr-modal").classList.add("hidden"));
        document.getElementById("daily-sales-table").addEventListener("click",e=>{e.target.closest(".edit-sale-btn")&&handleEditSale(e.target.closest(".edit-sale-btn").dataset.id),e.target.closest(".delete-sale-btn")&&handleDeleteSale(e.target.closest(".delete-sale-btn").dataset.id)});
        const cancellationModal=document.getElementById("cancellation-modal");document.getElementById("cancel-cancellation-btn").addEventListener("click",()=>cancellationModal.classList.add("hidden")),document.getElementById("cancellation-form").addEventListener("submit",async e=>{e.preventDefault();const t=e.target.querySelector("#cancellation-sale-id").value,n=e.target.querySelector("#cancellation-reason").value;if(n)try{await updateDoc(doc(db,"businesses",currentUser.uid,"sales",t),{status:"cancelled",cancellationReason:n}),showNotification("Venda cancelada com sucesso.","info"),cancellationModal.classList.add("hidden")}catch(e){showNotification("Erro ao cancelar a venda.","error")}else showNotification("Por favor, informe o motivo.","error")});
        function handleEditSale(e){const t=dailySales.find(t=>t.id===e);if(t){resetSaleForm(),editingSaleId=e,document.getElementById("save-sale-btn").textContent="Atualizar Venda";const n=allClients.find(e=>e.id===t.clientId);n?selectClient(n):ui.clientSearch.value=t.clientName,t.items.forEach(e=>{const t=e.isPackage?`${e.id}-package`:e.isPackageUsage?`${e.id}-usage-${Date.now()}`:e.id;selectedItems.set(t,{...e})}),renderSelectedItems(),calculateTotal(),dailySalesModal.classList.add("hidden"),window.scrollTo({top:0,behavior:"smooth"})}}
        function handleDeleteSale(e){cancellationModal.querySelector("#cancellation-sale-id").value=e,cancellationModal.querySelector("#cancellation-reason").value="",cancellationModal.classList.remove("hidden")}
    </script>
</body>
</html>

