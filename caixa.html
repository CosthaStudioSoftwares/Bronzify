<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
        if (sessionStorage.getItem('acessoLiberado') !== 'true') {
            window.location.href = 'dashboard.html';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .accordion-content { overflow: hidden; transition: max-height 0.3s ease-out; }
        .notification-badge { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .quantity-input { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                <h2 class="text-3xl lg:text-4xl text-gray-800">Frente de Caixa</h2>
                <div class="relative">
                    <button id="incoming-orders-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <i data-lucide="bell" class="w-6 h-6 text-gray-700"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-2xl text-gray-800 mb-4">1. Selecionar Cliente</h3>
                        <div class="relative"><input type="text" id="client-search" placeholder="Digite o nome ou telefone da cliente..." class="w-full p-2 border rounded-lg"><div id="search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg"></div></div>
                        <div id="selected-client-display" class="mt-4 hidden items-center gap-3 bg-rose-50 p-3 rounded-lg"><p class="font-semibold text-gray-700">Cliente: <span id="selected-client-name"></span></p><div id="birthday-alert" class="hidden items-center gap-1 text-sm text-pink-600 font-semibold"><i data-lucide="cake" class="w-4 h-4"></i><span>Aniversariante do mês!</span></div></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-2xl text-gray-800 mb-4">2. Serviços e Produtos</h3>
                        <div id="items-container" class="space-y-2">
                            <!-- Categorias (accordion) serão inseridas aqui pelo JS -->
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-md lg:sticky top-8">
                        <h3 class="text-2xl text-gray-800 mb-4">3. Resumo da Venda</h3>
                        <div id="order-details" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm font-semibold text-blue-800">Pedido online carregado. Finalize a venda.</p>
                        </div>
                        <div class="space-y-3 mb-4">
                            <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                            <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span>Desconto</span><div class="flex border rounded-md text-xs"><button id="discount-type-value" class="px-2 py-1 bg-rose-100 text-rose-700 rounded-l-md">R$</button><button id="discount-type-percent" class="px-2 py-1 bg-gray-100 text-gray-500 rounded-r-md">%</button></div></div><input type="text" id="discount-input" placeholder="0,00" class="w-24 p-1 border rounded-md text-right"></div>
                            <div class="flex justify-between text-sm pr-1"><span>&nbsp;</span><span id="discount-applied">- R$ 0,00</span></div>
                            <hr>
                            <div class="flex justify-between font-bold text-xl"><span>TOTAL</span><span id="total">R$ 0,00</span></div>
                        </div>
                        <h4 class="font-semibold text-gray-600 mb-2">Forma de Pagamento</h4>
                        <select id="payment-method" class="w-full p-2 border rounded-lg mb-4"><option>Dinheiro</option><option>PIX</option><option>Débito</option><option>Crédito</option><option>A Prazo</option><option>Parceria</option></select>
                        <button id="save-sale-btn" class="w-full bg-gradient-to-r from-pink-500 to-[#B76E79] text-white py-3 rounded-lg font-bold text-lg">Salvar Venda</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-white p-6 rounded-2xl shadow-md">
                <h3 class="text-2xl text-gray-800 mb-4">Atendimentos do Dia</h3>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-2">Senha</th><th class="p-2">Cliente</th><th class="p-2">Horário</th><th class="p-2">Valor</th><th class="p-2">Pagamento</th><th class="p-2">Ações</th></tr></thead><tbody id="daily-sales-table"></tbody></table></div>
            </div>
        </main>
    </div>

    <div id="incoming-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8">
            <h3 class="text-2xl text-gray-800 mb-6">Pedidos Online Pendentes</h3>
            <div id="incoming-orders-list" class="space-y-4 max-h-[60vh] overflow-y-auto">
                <p class="text-gray-500">Nenhum pedido pendente no momento.</p>
            </div>
            <button id="close-orders-modal-btn" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    
    <div id="password-qr-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 text-center">
            <h3 class="text-2xl text-gray-800 mb-2">Venda Concluída!</h3>
            <p class="text-gray-600">A senha da cliente é:</p><p id="modal-password" class="text-7xl font-bold text-[#B76E79] my-4"></p>
            <p class="text-gray-600 mb-4">Peça para a cliente escanear o QR Code abaixo.</p>
            <div id="qrcode-container" class="flex justify-center items-center p-4 border rounded-lg"></div>
            <button id="close-qr-modal-btn" class="w-full mt-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Fechar</button>
        </div>
    </div>

    <script>lucide.createIcons();</script>
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot, getDocs, where, Timestamp, increment, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedClient = null;
        let allClients = [];
        let allProducts = [];
        let allStockItems = [];
        let pendingOrders = [];
        let loadedOnlineOrder = null;
        let synth = null;
        let editingSaleId = null;
        let discountType = 'value';
        
        const clientSearchInput = document.getElementById('client-search');
        const searchResultsContainer = document.getElementById('search-results');
        const totalEl = document.getElementById('total');
        const subtotalEl = document.getElementById('subtotal');
        const discountInputEl = document.getElementById('discount-input');
        const discountAppliedEl = document.getElementById('discount-applied');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadAllClients();
                loadAllProducts();
                loadDailySales();
                listenForIncomingOrders();
                document.body.addEventListener('click', async () => { if (!synth) { await Tone.start(); synth = new Tone.Synth().toDestination(); }}, { once: true });
            } else { window.location.href = './index.html'; }
        });
        
        async function loadAllClients() {
            const clientsRef = collection(db, "businesses", currentUser.uid, "clients");
            const snapshot = await getDocs(clientsRef);
            allClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadAllProducts() {
            const productsRef = collection(db, "businesses", currentUser.uid, "products");
            const stockItemsRef = collection(db, "businesses", currentUser.uid, "stock_items");
            const [productsSnap, stockItemsSnap] = await Promise.all([
                getDocs(query(productsRef, orderBy("name"))),
                getDocs(query(stockItemsRef, orderBy("name")))
            ]);
            allProducts = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allStockItems = stockItemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'stock' }));
            renderProductAccordions();
        }

        function renderProductAccordions() {
            const itemsContainer = document.getElementById('items-container');
            itemsContainer.innerHTML = '';
            const categories = [
                { id: 'bronze', name: 'Tipos de Bronze', items: allProducts.filter(p => p.category === 'bronze') },
                { id: 'consumable', name: 'Consumo', items: allProducts.filter(p => p.category === 'consumable') },
                { id: 'extra', name: 'Adicionais', items: allProducts.filter(p => p.category === 'extra') },
                { id: 'stock', name: 'Estoque', items: allStockItems }
            ];
            categories.forEach(cat => {
                if (cat.items.length === 0) return;
                const accordionDiv = document.createElement('div');
                accordionDiv.innerHTML = `
                    <div data-accordion-trigger="${cat.id}" class="flex justify-between items-center cursor-pointer border-b p-2 hover:bg-gray-50 rounded-t-lg">
                        <h4 class="font-semibold text-gray-700">${cat.name}</h4>
                        <i data-lucide="chevron-down" class="transition-transform duration-300"></i>
                    </div>
                    <div id="${cat.id}-panel" class="accordion-content max-h-0">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-t-0 rounded-b-lg">
                            ${cat.items.map(item => createItemHTML(item)).join('')}
                        </div>
                    </div>`;
                itemsContainer.appendChild(accordionDiv);
            });
            lucide.createIcons();
            rebindAllEvents();
        }

        function createItemHTML(item) {
            const priceFormatted = (item.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const itemCategory = item.type === 'stock' ? 'stock' : item.category;
            if (itemCategory === 'stock' || itemCategory === 'consumable') {
                return `<div class="consumable-item border rounded-lg p-3" data-price="${item.price}" data-name="${item.name}" data-id="${item.id}" data-type="${itemCategory}">
                    <div class="flex items-center justify-between"><span class="font-semibold">${item.name}</span><span class="text-gray-500 text-sm">(${priceFormatted})</span></div>
                    <div class="flex items-center gap-2 mt-2 justify-end">
                        <button type="button" class="quantity-btn minus-btn bg-rose-200 text-rose-700 rounded-full w-7 h-7">-</button>
                        <input type="number" value="0" min="0" class="quantity-input w-12 text-center border rounded-md">
                        <button type="button" class="quantity-btn plus-btn bg-rose-200 text-rose-700 rounded-full w-7 h-7">+</button>
                    </div></div>`;
            } else if (itemCategory === 'bronze') {
                return `<div class="service-item border rounded-lg p-3" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}" data-type="bronze">
                    <div class="flex items-center"><input type="checkbox" id="${item.id}" class="service-checkbox h-5 w-5 rounded"><label for="${item.id}" class="ml-3 cursor-pointer"><span class="font-semibold">${item.name}</span><span class="service-price-display font-bold text-gray-600 ml-2">${priceFormatted}</span></label></div>
                    <div class="package-option-container pl-8 pt-2 mt-2 border-t"><input type="checkbox" id="pkg-${item.id}" class="package-checkbox h-4 w-4 rounded"><label for="pkg-${item.id}" class="ml-2 text-sm">Comprar Pacote</label></div>
                    </div>`;
            } else {
                return `<div class="service-item-container" data-type="extra"><input type="checkbox" id="${item.id}" data-price="${item.price}" data-name="${item.name}" class="hidden"><label for="${item.id}" class="flex items-center justify-between border rounded-lg p-3 cursor-pointer"><span>${item.name}</span><span class="font-bold">${priceFormatted}</span></label></div>`;
            }
        }
        
        document.getElementById('items-container').addEventListener('click', (e) => {
            const trigger = e.target.closest('[data-accordion-trigger]');
            if(trigger) {
                const panel = document.getElementById(`${trigger.dataset.accordionTrigger}-panel`);
                const icon = trigger.querySelector('i[data-lucide]');
                if(panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                    icon.classList.remove('rotate-180');
                } else {
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                    icon.classList.add('rotate-180');
                }
            }
        });

        function rebindAllEvents() {
            document.querySelectorAll('.service-checkbox, .package-checkbox, .service-item-container input[type="checkbox"], .quantity-input').forEach(el => {
                el.addEventListener('change', calculateTotal);
                el.addEventListener('input', calculateTotal);
            });
            document.querySelectorAll('.minus-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const input = e.target.nextElementSibling;
                if (input.value > 0) input.value--;
                calculateTotal();
            }));
            document.querySelectorAll('.plus-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const input = e.target.previousElementSibling;
                input.value = parseInt(input.value) + 1;
                calculateTotal();
            }));
        }

        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('.service-item[data-type="bronze"]').forEach(el => {
                const checkbox = el.querySelector('.service-checkbox');
                if (checkbox && checkbox.checked) {
                     subtotal += parseFloat(el.dataset.price);
                }
            });
            document.querySelectorAll('.service-item-container[data-type="extra"] input:checked').forEach(el => {
                subtotal += parseFloat(el.dataset.price);
            });
            document.querySelectorAll('.consumable-item').forEach(el => {
                const quantity = parseInt(el.querySelector('.quantity-input').value) || 0;
                if(quantity > 0) {
                    subtotal += parseFloat(el.dataset.price) * quantity;
                }
            });
            
            subtotalEl.textContent = subtotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            let discount = 0;
            const discountValue = parseFloat(discountInputEl.value.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
            if (discountType === 'value') {
                discount = discountValue;
            } else {
                discount = subtotal * (discountValue / 100);
            }
            
            discountAppliedEl.textContent = `- ${discount.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
            totalEl.textContent = (subtotal - discount).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }
        
        function listenForIncomingOrders() {
            const ordersRef = collection(db, "businesses", currentUser.uid, "incoming_orders");
            const q = query(ordersRef, where("status", "==", "pending"));
            onSnapshot(q, (snapshot) => {
                pendingOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateNotificationBadge(pendingOrders.length);
                if (snapshot.docChanges().some(change => change.type === 'added')) {
                    if (synth) synth.triggerAttackRelease("C5", "8n");
                }
            });
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
                badge.classList.add('notification-badge');
            } else {
                badge.classList.add('hidden');
                badge.classList.remove('notification-badge');
            }
        }
        
        document.getElementById('incoming-orders-btn').addEventListener('click', () => {
            renderIncomingOrders();
            document.getElementById('incoming-orders-modal').classList.remove('hidden');
        });
        document.getElementById('close-orders-modal-btn').addEventListener('click', () => {
            document.getElementById('incoming-orders-modal').classList.add('hidden');
        });

        function renderIncomingOrders() {
            const listEl = document.getElementById('incoming-orders-list');
            listEl.innerHTML = '';
            if (pendingOrders.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500">Nenhum pedido pendente.</p>';
                return;
            }
            pendingOrders.forEach(order => {
                const orderEl = document.createElement('div');
                orderEl.className = 'p-4 border rounded-lg';
                orderEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">${order.customerName}</p>
                            <p class="text-sm text-gray-600">${order.customerPhone}</p>
                            <p class="text-sm mt-2">Total: <span class="font-bold">${order.total.toLocaleString('pt-BR',{style:'currency', currency:'BRL'})}</span></p>
                        </div>
                        <div class="flex gap-2">
                            <button class="load-order-btn bg-green-500 text-white px-3 py-1 rounded" data-id="${order.id}">Carregar</button>
                            <button class="reject-order-btn bg-red-500 text-white px-3 py-1 rounded" data-id="${order.id}">Rejeitar</button>
                        </div>
                    </div>
                `;
                listEl.appendChild(orderEl);
            });
        }
        
        document.getElementById('incoming-orders-list').addEventListener('click', async (e) => {
            const orderId = e.target.dataset.id;
            if (!orderId) return;
            const orderRef = doc(db, "businesses", currentUser.uid, "incoming_orders", orderId);

            if (e.target.classList.contains('load-order-btn')) {
                const order = pendingOrders.find(o => o.id === orderId);
                if (order) {
                    resetSaleForm();
                    clientSearchInput.value = order.customerName; // Preenche o nome para referência
                    
                    order.items.forEach(item => {
                        const itemEl = document.querySelector(`[data-name="${item.name}"]`);
                        if (itemEl) {
                           const checkbox = itemEl.querySelector('.service-checkbox') || itemEl.querySelector('input[type="checkbox"]');
                           if(checkbox) checkbox.checked = true;
                           
                           const quantityInput = itemEl.querySelector('.quantity-input');
                           if(quantityInput) quantityInput.value = item.quantity;
                        }
                    });

                    document.getElementById('payment-method').value = order.paymentMethod;
                    document.getElementById('order-details').classList.remove('hidden');
                    loadedOnlineOrder = order;
                    calculateTotal();
                    document.getElementById('incoming-orders-modal').classList.add('hidden');
                    await updateDoc(orderRef, { status: 'loaded' });
                }
            } else if (e.target.classList.contains('reject-order-btn')) {
                if (await showConfirm('Rejeitar este pedido?')) {
                    await updateDoc(orderRef, { status: 'rejected' });
                    showNotification('Pedido rejeitado.', 'info');
                }
            }
        });

        // --- LÓGICA DE SALVAR VENDA (ATUALIZADA) ---
        document.getElementById('save-sale-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            
            const totalString = totalEl.textContent.replace(/\D/g, '');
            const totalValue = totalString ? parseInt(totalString) / 100 : 0;
            if(totalValue <= 0) {
                showNotification('O valor da venda não pode ser zero.', 'info');
                return;
            }

            const saleItems = [];
            // Bronze e Adicionais
            document.querySelectorAll('.service-checkbox:checked, .service-item-container input:checked').forEach(el => {
                saleItems.push({ name: el.dataset.name, price: parseFloat(el.dataset.price), quantity: 1, type: el.closest('[data-type]').dataset.type, id: el.id });
            });
            // Consumo e Estoque
            document.querySelectorAll('.consumable-item').forEach(el => {
                const quantity = parseInt(el.querySelector('.quantity-input').value);
                if (quantity > 0) {
                    saleItems.push({ name: el.dataset.name, price: parseFloat(el.dataset.price), quantity, type: el.dataset.type, id: el.dataset.id });
                }
            });

            const salePayload = {
                clientName: selectedClient ? selectedClient.name : clientSearchInput.value || "Cliente Avulso",
                clientId: selectedClient ? selectedClient.id : null,
                total: totalValue,
                paymentMethod: document.getElementById('payment-method').value,
                items: saleItems,
                createdAt: Timestamp.now(),
                status: 'waiting'
            };

            try {
                const batch = writeBatch(db);

                // Deduzir do estoque
                saleItems.forEach(item => {
                    if (item.type === 'stock') {
                        const stockItemRef = doc(db, "businesses", currentUser.uid, "stock_items", item.id);
                        batch.update(stockItemRef, { quantity: increment(-item.quantity) });
                    }
                });

                // Salvar a venda
                const saleRef = doc(collection(db, "businesses", currentUser.uid, "sales"));
                batch.set(saleRef, salePayload);

                // Se era um pedido online, marca como concluído
                if (loadedOnlineOrder) {
                    const orderRef = doc(db, "businesses", currentUser.uid, "incoming_orders", loadedOnlineOrder.id);
                    batch.update(orderRef, { status: 'completed' });
                }

                await batch.commit();

                showNotification('Venda salva com sucesso!', 'success');
                // Adicionar lógica de QR Code aqui se necessário
                resetSaleForm();
            } catch (error) {
                console.error("Erro ao salvar venda:", error);
                showNotification('Erro ao salvar a venda.', 'error');
            }
        });

        // Outras funções de suporte
        function resetSaleForm() {
            editingSaleId = null;
            selectedClient = null;
            loadedOnlineOrder = null;
            clientSearchInput.value = '';
            document.getElementById('selected-client-display').style.display = 'none';
            document.getElementById('order-details').classList.add('hidden');
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('.quantity-input').forEach(input => input.value = 0);
            discountInputEl.value = '';
            calculateTotal();
        }

        async function loadDailySales() {
            const tableBody = document.getElementById('daily-sales-table');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Carregando...</td></tr>';
            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
            const salesRef = collection(db, "businesses", currentUser.uid, "sales");
            const q = query(salesRef, where("createdAt", ">=", Timestamp.fromDate(todayStart)), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                tableBody.innerHTML = '';
                if(snapshot.empty) {
                     tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhuma venda hoje.</td></tr>';
                     return;
                }
                snapshot.forEach(doc => {
                    const sale = {id: doc.id, ...doc.data()};
                    const saleTime = sale.createdAt.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="p-2 font-mono">${sale.password || 'N/A'}</td>
                        <td class="p-2 font-semibold">${sale.clientName}</td>
                        <td class="p-2">${saleTime}</td>
                        <td class="p-2">${(sale.total || 0).toLocaleString('pt-BR', {style:'currency', currency: 'BRL'})}</td>
                        <td class="p-2">${sale.paymentMethod}</td>
                        <td class="p-2 flex items-center gap-2">
                           <button class="delete-sale-btn p-1 text-gray-500 hover:text-red-600" data-id="${sale.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                        </td>`;
                    tableBody.appendChild(row);
                });
                lucide.createIcons();
            });
        }

        document.getElementById('daily-sales-table').addEventListener('click', async e => {
            const deleteBtn = e.target.closest('.delete-sale-btn');
            if(deleteBtn) {
                if (await showConfirm("Tem certeza que deseja excluir esta venda? Esta ação não pode ser desfeita.")) {
                    // Aqui seria necessária uma lógica mais complexa para reverter o estoque, se desejado.
                    // Por simplicidade, apenas excluímos a venda por enquanto.
                    await deleteDoc(doc(db, "businesses", currentUser.uid, "sales", deleteBtn.dataset.id));
                    showNotification("Venda excluída.", 'info');
                }
            }
        });
    </script>
</body>
</html>

