<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
    // --- TRANCA DE SEGURANÇA DE PÁGINA ---
    try {
        const permissionsString = sessionStorage.getItem('userPermissions');
        // Pega o nome do arquivo atual (ex: 'dashboard') para usar como ID da permissão
        const currentPageId = window.location.pathname.split('/').pop().replace('.html', '');

        // Se não houver permissões salvas na sessão, o usuário não está logado corretamente.
        if (!permissionsString) {
            window.location.href = './index.html';
        } else {
            const permissions = JSON.parse(permissionsString);
            // Um objeto de permissões vazio significa que é o admin, que tem acesso a tudo.
            const isAdmin = Object.keys(permissions).length === 0;

            // A permissão é negada se o usuário NÃO for admin E a permissão para a página atual for 'false'.
            if (!isAdmin && permissions[currentPageId] === false) {
                // Sobrescreve todo o conteúdo da página com a mensagem de Acesso Negado.
                document.write(`
                    <html lang="pt-BR">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Acesso Negado</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <script src="https://unpkg.com/lucide@latest"><\/script>
                        <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
                        <style>body { font-family: 'Poppins', sans-serif; } h1 { font-family: 'Playfair Display', serif; }</style>
                    </head>
                    <body class="bg-gray-100 flex items-center justify-center h-screen">
                        <div class="text-center bg-white p-12 rounded-2xl shadow-lg max-w-lg mx-auto">
                            <i data-lucide="shield-alert" class="mx-auto w-16 h-16 text-red-500"></i>
                            <h1 class="text-4xl mt-4 text-gray-800">Acesso Negado</h1>
                            <p class="text-gray-600 mt-2">Você não tem permissão para acessar esta página. Por favor, contate o administrador do sistema.</p>
                            <a href="./dashboard.html" class="mt-6 inline-block bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">Voltar para a Página Inicial</a>
                        </div>
                        <script>lucide.createIcons();<\/script>
                    </body>
                    </html>
                `);
            }
        }
    } catch (e) {
        // Em caso de qualquer erro, redireciona para o login por segurança.
        console.error("Erro na verificação de permissão:", e);
        window.location.href = './index.html';
    }
</script>
    
    <script>
        if (sessionStorage.getItem('acessoLiberado') !== 'true') {
            window.location.href = 'dashboard.html';
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caixa - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3, h4 { font-family: 'Playfair Display', serif; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; border-radius: 0.75rem; color: #4A5568; transition: all 0.3s ease; font-weight: 500; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .sidebar-link svg { margin-right: 0.75rem; }
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.open { transform: translateX(0); }
        .notification-badge { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .quantity-input { -moz-appearance: textfield; }
        #main-content-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(249, 250, 251, 0.8);
            backdrop-filter: blur(4px);
            z-index: 49;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen bg-gray-50">
        <div class="flex-1 flex flex-col overflow-hidden">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8 relative z-50">
                <div class="flex items-center gap-4">
                    <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                    <h2 class="text-3xl lg:text-4xl text-gray-800">Frente de Caixa</h2>
                    <div class="hidden lg:flex items-center gap-2 border-l pl-4 ml-4">
                        <button id="cash-flow-btn" class="flex items-center gap-2 p-2 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-lg">
                           <i data-lucide="arrow-right-left" class="w-4 h-4"></i> <span>Abertura/Fechamento</span>
                        </button>
                       <button id="show-daily-sales-btn" class="flex items-center gap-2 p-2 text-sm font-semibold text-gray-600 hover:bg-gray-100 rounded-lg">
                           <i data-lucide="history" class="w-4 h-4"></i> <span>Atendimentos do Dia</span>
                       </button>
                    </div>
                </div>
                <div class="relative">
                    <button id="incoming-orders-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <i data-lucide="bell" class="w-6 h-6 text-gray-700"></i>
                        <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </header>
            
            <div class="relative">
                <div id="main-content-overlay" class="flex items-center justify-center rounded-2xl">
                    <div class="text-center">
                        <i data-lucide="lock" class="w-12 h-12 mx-auto text-gray-400"></i>
                        <p class="mt-4 font-semibold text-gray-600">O caixa está fechado. Clique em "Abertura/Fechamento" para começar.</p>
                    </div>
                </div>
                
                <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-2xl text-gray-800 mb-4">1. Selecionar Cliente</h3>
                            <div class="relative">
                                <input type="text" id="client-search" placeholder="Digite o nome ou telefone da cliente..." class="w-full p-2 border rounded-lg">
                                <div id="search-results" class="absolute z-40 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg"></div>
                            </div>
                            <div id="selected-client-display" class="mt-4 hidden items-center gap-3 bg-rose-50 p-3 rounded-lg">
                                <p class="font-semibold text-gray-700">Cliente: <span id="selected-client-name"></span></p>
                                <div id="birthday-alert" class="hidden items-center gap-1 text-sm text-pink-600 font-semibold"><i data-lucide="cake" class="w-4 h-4"></i><span>Aniversariante do mês!</span></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-md">
                            <h3 class="text-2xl text-gray-800 mb-4">2. Serviços e Produtos</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="space-y-6">
                                    <div>
                                        <label class="font-semibold text-gray-700">Tipos de Bronze</label>
                                        <div class="relative mt-1">
                                            <input type="text" id="bronze-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg">
                                            <div id="bronze-search-results" class="absolute z-30 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div>
                                        </div>
                                        <div id="selected-bronze-items" class="mt-3 space-y-2"></div>
                                    </div>
                                    <div>
                                        <label class="font-semibold text-gray-700">Adicionais</label>
                                        <div class="relative mt-1">
                                            <input type="text" id="extra-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg">
                                            <div id="extra-search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div>
                                        </div>
                                        <div id="selected-extra-items" class="mt-3 space-y-2"></div>
                                    </div>
                                </div>
                                <div class="space-y-6">
                                    <div>
                                        <label class="font-semibold text-gray-700">Consumo</label>
                                        <div class="relative mt-1">
                                            <input type="text" id="consumable-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg">
                                            <div id="consumable-search-results" class="absolute z-20 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div>
                                        </div>
                                        <div id="selected-consumable-items" class="mt-3 space-y-2"></div>
                                    </div>
                                    <div>
                                        <label class="font-semibold text-gray-700">Estoque</label>
                                        <div class="relative mt-1">
                                            <input type="text" id="stock-search" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg">
                                            <div id="stock-search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden shadow-lg"></div>
                                        </div>
                                        <div id="selected-stock-items" class="mt-3 space-y-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-2xl shadow-md lg:sticky top-8">
                            <h3 class="text-2xl text-gray-800 mb-4">3. Resumo da Venda</h3>
                            <div id="order-details" class="hidden mb-4 p-3 bg-blue-50 border rounded-lg">
                                <p class="text-sm font-semibold text-blue-800">Pedido online carregado.</p>
                            </div>
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">R$ 0,00</span></div>
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span>Desconto</span>
                                        <div class="flex border rounded-md text-xs">
                                            <button id="discount-type-value" class="px-2 py-1 bg-rose-100 text-rose-700 rounded-l-md">R$</button>
                                            <button id="discount-type-percent" class="px-2 py-1 bg-gray-100 text-gray-500 rounded-r-md">%</button>
                                        </div>
                                    </div>
                                    <input type="text" id="discount-input" placeholder="0,00" class="w-24 p-1 border rounded-md text-right">
                                </div>
                                <div class="flex justify-between text-sm pr-1"><span>&nbsp;</span><span id="discount-applied">- R$ 0,00</span></div>
                                <hr>
                                <div class="flex justify-between font-bold text-xl"><span>TOTAL</span><span id="total">R$ 0,00</span></div>
                            </div>
                            <h4 class="font-semibold text-gray-600 mb-2">Forma de Pagamento</h4>
                            <select id="payment-method" class="w-full p-2 border rounded-lg mb-4">
                                <option>Dinheiro</option>
                                <option>PIX</option>
                                <option>Débito</option>
                                <option>Crédito</option>
                                <option>A Prazo</option>
                                <option>Parceria</option>
                                <option>Permuta</option>
                            </select>
                            <button id="save-sale-btn" class="w-full bg-gradient-to-r from-pink-500 to-[#B76E79] text-white py-3 rounded-lg font-bold text-lg">Salvar Venda</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        </div>
    </div>

    <div id="cash-flow-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8">
            <h3 class="text-2xl text-gray-800 mb-2">Abertura / Fechamento de Caixa</h3>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex gap-6" aria-label="Tabs">
                    <button id="tab-control" class="tab-btn border-b-2 border-[#B76E79] text-[#B76E79] py-4 px-1 text-sm font-medium">Controle</button>
                    <button id="tab-history" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 text-sm font-medium">Histórico</button>
                </nav>
            </div>
            <div id="control-panel" class="mt-6"></div>
            <div id="history-panel" class="mt-6 hidden">
                <div class="flex gap-4 items-end">
                    <div class="flex-grow">
                        <label for="history-date" class="block text-gray-600 mb-1">Pesquisar por Data</label>
                        <input type="date" id="history-date" class="w-full p-2 border rounded-lg">
                    </div>
                    <button id="search-history-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Buscar</button>
                </div>
                <div id="history-results" class="mt-4 space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
            <button type="button" id="close-cash-flow-modal" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 overflow-y-auto max-h-screen">
            <h3 class="text-2xl text-gray-800 mb-4">Relatório de Fechamento</h3>
            <div id="report-content-modal" class="text-gray-700 space-y-2"></div>
            <div class="flex gap-4 mt-6">
                <button id="download-report-btn" class="w-full flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Baixar PDF</button>
                <button id="close-report-modal" class="w-full flex-1 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
            </div>
        </div>
    </div>
    <div id="incoming-orders-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8">
            <h3 class="text-2xl text-gray-800 mb-6">Pedidos Online Pendentes</h3>
            <div id="incoming-orders-list" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
            <button id="close-orders-modal-btn" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    <div id="password-qr-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 text-center">
            <h3 class="text-2xl text-gray-800 mb-2">Venda Concluída!</h3>
            <p class="text-gray-600">A senha da cliente é:</p>
            <p id="modal-password" class="text-7xl font-bold text-[#B76E79] my-4"></p>
            <p class="text-gray-600 mb-4">Peça para a cliente escanear o QR Code abaixo.</p>
            <div id="qrcode-container" class="flex justify-center items-center p-4 border rounded-lg"></div>
            <button id="close-qr-modal-btn" class="w-full mt-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold">Fechar</button>
        </div>
    </div>
    <div id="daily-sales-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl p-8">
            <h3 class="text-2xl text-gray-800 mb-6">Atendimentos do Dia</h3>
            <div class="overflow-y-auto max-h-[70vh]">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b">
                            <th class="p-2">Senha</th>
                            <th class="p-2">Cliente</th>
                            <th class="p-2">Horário</th>
                            <th class="p-2">Valor</th>
                            <th class="p-2">Pagamento</th>
                            <th class="p-2">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="daily-sales-table"></tbody>
                </table>
            </div>
            <button id="close-daily-sales-btn" class="w-full mt-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Fechar</button>
        </div>
    </div>
    <div id="cancellation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
            <h3 class="text-2xl text-gray-800 mb-4">Cancelar Venda</h3>
            <p class="text-gray-600 mb-4">Por favor, informe o motivo do cancelamento.</p>
            <form id="cancellation-form">
                <input type="hidden" id="cancellation-sale-id">
                <textarea id="cancellation-reason" class="w-full p-2 border rounded-lg" rows="3" required></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="cancel-cancellation-btn" class="px-6 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Voltar</button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar Cancelamento</button>
                </div>
            </form>
        </div>
    </div>

    <script>lucide.createIcons();</script>
    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot, getDocs, where, Timestamp, increment, writeBatch, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, businessId = null, selectedClient = null, loadedOnlineOrder = null, synth = null, editingSaleId = null, discountType = 'value';
        let allClients = [], allProducts = [], allStockItems = [], pendingOrders = [], dailySales = [];
        let selectedItems = new Map();
        
        const ui = {
            clientSearch: document.getElementById('client-search'), searchResults: document.getElementById('search-results'),
            bronzeSearch: document.getElementById('bronze-search'), bronzeSearchResults: document.getElementById('bronze-search-results'),
            consumableSearch: document.getElementById('consumable-search'), consumableSearchResults: document.getElementById('consumable-search-results'),
            stockSearch: document.getElementById('stock-search'), stockSearchResults: document.getElementById('stock-search-results'),
            extraSearch: document.getElementById('extra-search'), extraSearchResults: document.getElementById('extra-search-results'),
            selectedBronzeItems: document.getElementById('selected-bronze-items'),
            selectedConsumableItems: document.getElementById('selected-consumable-items'),
            selectedStockItems: document.getElementById('selected-stock-items'),
            selectedExtraItems: document.getElementById('selected-extra-items'),
            subtotal: document.getElementById('subtotal'), discountInput: document.getElementById('discount-input'),
            discountApplied: document.getElementById('discount-applied'), total: document.getElementById('total'),
        };

        onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        businessId = sessionStorage.getItem('businessId'); // Pega o ID da empresa

        if (!businessId) {
            window.location.href = 'index.html';
            return;
        }

        checkCashRegisterStatus();
        loadInitialData();
        document.body.addEventListener('click', async () => { if (!synth) { await Tone.start(); synth = new Tone.Synth().toDestination(); }}, { once: true });
    } else { window.location.href = 'index.html'; }
});

        async function loadInitialData() {
            const clientsRef = collection(db, "businesses", businessId, "clients");
            const productsRef = collection(db, "businesses", businessId, "products");
            const stockItemsRef = collection(db, "businesses", businessId, "stock_items");
            const [clientsSnap, productsSnap, stockItemsSnap] = await Promise.all([ getDocs(clientsRef), getDocs(query(productsRef, orderBy("name"))), getDocs(query(stockItemsRef, orderBy("name"))) ]);
            allClients = clientsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allProducts = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allStockItems = stockItemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), type: 'stock' }));
            listenForIncomingOrders();
            listenForDailySales();
        }

        const cashFlowModal = document.getElementById('cash-flow-modal');
        const mainContentOverlay = document.getElementById('main-content-overlay');
        mainContentOverlay.addEventListener('click', () => { renderControlPanel(); cashFlowModal.classList.remove('hidden'); });
        function checkCashRegisterStatus() {
            const cashRegister = JSON.parse(sessionStorage.getItem('cashRegister'));
            if (cashRegister && cashRegister.status === 'open') mainContentOverlay.classList.add('hidden');
            else mainContentOverlay.classList.remove('hidden');
        }
        document.getElementById('cash-flow-btn').addEventListener('click', () => { renderControlPanel(); cashFlowModal.classList.remove('hidden'); });
        document.getElementById('close-cash-flow-modal').addEventListener('click', () => cashFlowModal.classList.add('hidden'));
        document.getElementById('tab-control').addEventListener('click', (e) => {
            document.getElementById('control-panel').classList.remove('hidden'); document.getElementById('history-panel').classList.add('hidden');
            e.target.classList.add('border-[#B76E79]', 'text-[#B76E79]');
            document.getElementById('tab-history').classList.remove('border-[#B76E79]', 'text-[#B76E79]');
            document.getElementById('tab-history').classList.add('border-transparent', 'text-gray-500');
        });
        document.getElementById('tab-history').addEventListener('click', (e) => {
            document.getElementById('control-panel').classList.add('hidden'); document.getElementById('history-panel').classList.remove('hidden');
            e.target.classList.add('border-[#B76E79]', 'text-[#B76E79]');
            document.getElementById('tab-control').classList.remove('border-[#B76E79]', 'text-[#B76E79]');
            document.getElementById('tab-control').classList.add('border-transparent', 'text-gray-500');
        });
        
        function renderControlPanel() {
            const controlPanel = document.getElementById('control-panel');
            const cashRegister = JSON.parse(sessionStorage.getItem('cashRegister'));
            if (cashRegister && cashRegister.status === 'open') {
                controlPanel.innerHTML = `<p class="mb-4">Caixa aberto por: <span class="font-bold">${cashRegister.operatorName}</span></p><button id="close-cash-btn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">Fechar Caixa</button>`;
                document.getElementById('close-cash-btn').addEventListener('click', handleCloseCash);
            } else {
                controlPanel.innerHTML = `<form id="open-cash-form" class="space-y-4"><div><label for="operator-name" class="font-semibold text-gray-700">Seu Nome</label><input type="text" id="operator-name" class="w-full p-2 border rounded-lg mt-1" required></div><div><label for="initial-change" class="font-semibold text-gray-700">Valor de Troco Inicial</label><input type="text" id="initial-change" class="w-full p-2 border rounded-lg mt-1" placeholder="R$ 0,00" required></div><button type="submit" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Abrir Caixa</button></form>`;
                document.getElementById('initial-change').addEventListener('input', (e) => { let v = e.target.value.replace(/\D/g, ''); e.target.value = v ? (parseInt(v) / 100).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : ''; });
                document.getElementById('open-cash-form').addEventListener('submit', handleOpenCash);
            }
        }
        async function handleOpenCash(e) {
            e.preventDefault();
            const operatorName = document.getElementById('operator-name').value;
            const initialChange = parseFloat(document.getElementById('initial-change').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            const newShift = { operatorName, initialChange, openTime: Timestamp.now(), status: 'open' };
            try {
                const shiftRef = doc(collection(db, "businesses", businessId, "cash_shifts"));
                await setDoc(shiftRef, newShift);
                sessionStorage.setItem('cashRegister', JSON.stringify({ ...newShift, shiftId: shiftRef.id, openTime: newShift.openTime.toMillis() }));
                showNotification('Caixa aberto com sucesso!', 'success');
                cashFlowModal.classList.add('hidden');
                checkCashRegisterStatus();
            } catch (error) { console.error("Erro ao abrir caixa:", error); showNotification('Erro ao abrir caixa.', 'error'); }
        }
        
        async function handleCloseCash() {
            const patioSalesRef = query(collection(db, "businesses", businessId, "sales"), where("status", "==", "called"));
            const patioSnapshot = await getDocs(patioSalesRef);

            let confirmationMessage = 'Deseja realmente fechar o caixa agora?';
            if (!patioSnapshot.empty) {
                confirmationMessage = `Atenção: ${patioSnapshot.size} cliente(s) ainda estão no pátio. Deseja mesmo fechar o caixa?`;
            }

            const confirmed = await showConfirm(confirmationMessage, 'Confirmar Fechamento', 'Sim, Fechar');
            if (!confirmed) return;
            
            const cashRegister = JSON.parse(sessionStorage.getItem('cashRegister'));
            const openTime = new Date(cashRegister.openTime);
            const salesRef = query(collection(db, "businesses", businessId, "sales"), where("createdAt", ">=", openTime));

            
            try {
                const salesSnapshot = await getDocs(salesRef);
                let totalClients = 0;
                const paymentTotals = {};
                const canceledSales = [];
                
                salesSnapshot.forEach(doc => {
                    const sale = doc.data();
                    if(sale.createdAt.toDate() >= openTime) {
                        if(sale.status === 'cancelled') {
                            canceledSales.push(sale);
                        } else {
                            totalClients++;
                            const method = sale.paymentMethod || 'N/A';
                            paymentTotals[method] = (paymentTotals[method] || 0) + sale.total;
                        }
                    }
                });

                const closingData = {
                    closeTime: Timestamp.now(),
                    totalClients: totalClients,
                    paymentTotals: paymentTotals,
                    status: 'closed',
                    canceledSalesCount: canceledSales.length
                };
                
                const reportData = { ...cashRegister, ...closingData, canceledSales };

                await updateDoc(doc(db, "businesses", businessId, "cash_shifts", cashRegister.shiftId), closingData);
                
                sessionStorage.removeItem('cashRegister');
                showNotification('Caixa fechado com sucesso!', 'info');
                cashFlowModal.classList.add('hidden');
                checkCashRegisterStatus();
                displayReportModal(reportData);
            } catch (error) {
                console.error("Erro ao fechar caixa:", error);
                showNotification('Erro ao fechar o caixa.', 'error');
            }
        }

        function displayReportModal(report) {
            const contentEl = document.getElementById('report-content-modal');
            let paymentHtml = '';
            for (const [method, total] of Object.entries(report.paymentTotals || {})) {
                paymentHtml += `<div class="flex justify-between"><span>${method}:</span><span class="font-semibold">${total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div>`;
            }

            let canceledSalesHtml = '';
            if (report.canceledSales && report.canceledSales.length > 0) {
                canceledSalesHtml += '<hr class="my-2"><p class="font-bold">Vendas Canceladas:</p>';
                report.canceledSales.forEach(sale => {
                    canceledSalesHtml += `<div class="text-sm border-t pt-1 mt-1"><p>${sale.clientName} - <span class="text-red-600">${(sale.total || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></p><p class="text-xs text-gray-500">Motivo: ${sale.cancellationReason || 'Não informado'}</p></div>`;
                });
            }

            const totalCash = (report.paymentTotals?.['Dinheiro'] || 0) + (report.initialChange || 0);
            const openTimeDate = report.openTime.toDate ? report.openTime.toDate() : new Date(report.openTime);
            const closeTimeDate = report.closeTime.toDate ? report.closeTime.toDate() : new Date(report.closeTime);

            contentEl.innerHTML = `<p><strong>Operador:</strong> ${report.operatorName}</p><p><strong>Abertura:</strong> ${openTimeDate.toLocaleString('pt-BR')}</p><p><strong>Fechamento:</strong> ${closeTimeDate.toLocaleString('pt-BR')}</p><hr class="my-2"><p><strong>Total de Atendimentos:</strong> ${report.totalClients}</p><div class="mt-2 border-t pt-2">${paymentHtml}</div><hr class="my-2"><div class="flex justify-between"><span>Troco Inicial:</span><span>${(report.initialChange || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div><div class="flex justify-between text-lg font-bold mt-2"><span>Total em Caixa (Dinheiro):</span><span>${totalCash.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</span></div>${canceledSalesHtml}`;
            
            document.getElementById('report-modal').classList.remove('hidden');
            document.getElementById('close-report-modal').onclick = () => document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('download-report-btn').onclick = () => generateReportPDF(report);
        }

        function generateReportPDF(report) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const openTimeDate = report.openTime.toDate ? report.openTime.toDate() : new Date(report.openTime);
            const closeTimeDate = report.closeTime.toDate ? report.closeTime.toDate() : new Date(report.closeTime);

            pdf.setFontSize(18); pdf.text("Relatório de Fechamento de Caixa", 14, 22);
            pdf.setFontSize(11); pdf.setTextColor(100);
            pdf.text(`Operador: ${report.operatorName}`, 14, 30);
            pdf.text(`Abertura: ${openTimeDate.toLocaleString('pt-BR')}`, 14, 36);
            pdf.text(`Fechamento: ${closeTimeDate.toLocaleString('pt-BR')}`, 14, 42);
            
            const summaryBody = [
                    ['Total de Atendimentos', report.totalClients.toString()],
                    ...Object.entries(report.paymentTotals || {}).map(([method, total]) => [method, total.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})]),
                    ['Troco Inicial', (report.initialChange || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})],
                    ['Total em Caixa (Dinheiro)', ((report.paymentTotals?.['Dinheiro'] || 0) + (report.initialChange || 0)).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})]
            ];
            pdf.autoTable({ head: [['Resumo Financeiro', 'Valor']], body: summaryBody, startY: 50, headStyles: {fillColor: [183,110,121]} });
            
            // Nova seção para vendas canceladas
            if (report.canceledSales && report.canceledSales.length > 0) {
                const canceledHead = [['Horário', 'Cliente', 'Valor', 'Pagamento', 'Motivo']];
                const canceledBody = report.canceledSales.map(sale => [
                    sale.createdAt.toDate().toLocaleTimeString('pt-BR'),
                    sale.clientName,
                    (sale.total || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}),
                    sale.paymentMethod,
                    sale.cancellationReason || 'N/A'
                ]);

                // Define a posição do título e o escreve no PDF
                const titleY = pdf.autoTable.previous.finalY + 15;
                pdf.setFontSize(14);
                pdf.text('Vendas Canceladas no Período', 14, titleY);

                // Cria a tabela logo abaixo do título
                pdf.autoTable({
                    head: canceledHead,
                    body: canceledBody,
                    startY: titleY + 5, // Posição inicial da tabela
                    headStyles: { fillColor: [220, 53, 69] } // Cor vermelha para destacar
                });
            }

            pdf.save(`fechamento_caixa_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        }
        
        document.getElementById('search-history-btn').addEventListener('click', async () => {
            const date = document.getElementById('history-date').value;
            if (!date) {
                showNotification("Por favor, selecione uma data.", "info");
                return;
            }

            const [year, month, day] = date.split('-').map(Number);
            const startOfDay = Timestamp.fromDate(new Date(year, month - 1, day, 0, 0, 0));
            const endOfDay = Timestamp.fromDate(new Date(year, month - 1, day, 23, 59, 59));

            const historyRef = collection(db, "businesses", businessId, "cash_shifts");
            const q = query(historyRef, where("openTime", ">=", startOfDay), where("openTime", "<=", endOfDay), where("status", "==", "closed"), orderBy("openTime", "desc"));
            
            try {
                const snapshot = await getDocs(q);
                const resultsEl = document.getElementById('history-results');
                resultsEl.innerHTML = '';
                if (snapshot.empty) {
                    resultsEl.innerHTML = '<p class="text-gray-500 p-4 text-center">Nenhum fechamento encontrado para esta data.</p>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const shift = {id: doc.id, ...doc.data()};
                    const shiftEl = document.createElement('div');
                    shiftEl.className = 'p-3 bg-gray-100 rounded-lg flex justify-between items-center';
                    shiftEl.innerHTML = `<div><p class="font-semibold">${shift.operatorName}</p><p class="text-xs text-gray-600">Aberto em: ${shift.openTime.toDate().toLocaleTimeString('pt-BR')}</p></div><button class="view-report-btn bg-white border rounded-lg px-3 py-1 text-sm" data-shift-id="${shift.id}">Ver Relatório</button>`;
                    resultsEl.appendChild(shiftEl);
                });
                lucide.createIcons();
            } catch (error) {
                console.error("Erro ao buscar histórico:", error);
                showNotification("Erro ao buscar histórico. Verifique o console (F12) para mais detalhes.", "error");
            }
        });

        document.getElementById('history-results').addEventListener('click', async (e) => {
            if(e.target.classList.contains('view-report-btn')) {
                const shiftId = e.target.dataset.shiftId;
                const shiftDoc = await getDoc(doc(db, "businesses", businessId, "cash_shifts", shiftId));
                if (shiftDoc.exists()) {
                    const shiftData = shiftDoc.data();
                    const openTime = shiftData.openTime.toDate();
                    const closeTime = shiftData.closeTime.toDate();
                    const salesRef = query(collection(db, "businesses", businessId, "sales"), 
                        where("createdAt", ">=", openTime), 
                        where("createdAt", "<=", closeTime),
                        where("status", "==", "cancelled")
                    );
                    const canceledSnapshot = await getDocs(salesRef);
                    shiftData.canceledSales = canceledSnapshot.docs.map(d => d.data());
                    displayReportModal(shiftData);
                }
            }
        });
        
        // --- LÓGICA DE BUSCA E SELEÇÃO DE ITENS ---
        Object.values(ui).forEach(el => {
            if (el && el.tagName === 'INPUT') {
                el.addEventListener('input', handleSearch);
                el.addEventListener('focus', handleSearch);
            }
        });
        document.addEventListener('click', (e) => {
             if (!e.target.closest('.relative')) {
                 document.querySelectorAll('[id$="-search-results"]').forEach(c => c.classList.add('hidden'));
            }
        });

        function handleSearch(e) {
            const input = e.target;
            const searchTerm = input.value.trim().toLowerCase();
            let results = [], container, type = input.id;
            switch(type) {
                case 'client-search': 
                    container = ui.searchResults; 
                    if (searchTerm.length < 2) { container.classList.add('hidden'); return; } 
                    results = allClients.filter(c => (c.name || '').toLowerCase().includes(searchTerm) || (c.phone && c.phone.includes(searchTerm))); 
                    break;
                case 'bronze-search': 
                    container = ui.bronzeSearchResults; 
                    results = allProducts.filter(p => p.category === 'bronze' && p.name.toLowerCase().includes(searchTerm)); 
                    break;
                case 'consumable-search': 
                    container = ui.consumableSearchResults; 
                    results = allProducts.filter(p => p.category === 'consumable' && p.name.toLowerCase().includes(searchTerm)); 
                    break;
                case 'stock-search': 
                    container = ui.stockSearchResults; 
                    results = allStockItems.filter(p => p.name.toLowerCase().includes(searchTerm)); 
                    break;
                case 'extra-search': 
                    container = ui.extraSearchResults; 
                    results = allProducts.filter(p => p.category === 'extra' && p.name.toLowerCase().includes(searchTerm)); 
                    break;
            }
            renderSearchResults(results, container, type);
        }

        function renderSearchResults(results, container, type) {
            container.innerHTML = '';
            if (results.length === 0) { 
                container.innerHTML = `<div class="p-3 text-gray-500">${type === 'client-search' ? 'Nenhum cliente encontrado.' : 'Nenhum item encontrado.'}</div>`; 
            } else {
                results.slice(0, 10).forEach(result => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 hover:bg-gray-100 cursor-pointer';
                    if (type === 'client-search') {
                        itemEl.textContent = `${result.name} - ${result.phone}`;
                        itemEl.onclick = () => selectClient(result);
                    } else {
                        itemEl.innerHTML = `<div class="flex justify-between"><span>${result.name}</span><span class="font-semibold">${(result.price || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></div>`;
                        itemEl.onclick = () => addItemToSale(result);
                    }
                    container.appendChild(itemEl);
                });
            }
            container.classList.remove('hidden');
        }
        
        async function addItemToSale(item) {
            let isPackage = false;
            if (item.category === 'bronze') {
                if (selectedClient) {
                    const remainingSessions = selectedClient.packages?.[item.name] || 0;
                    if (remainingSessions > 0) {
                        const usePackage = await showConfirm(`Esta cliente tem ${remainingSessions} sessão(ões) de ${item.name}. Deseja usar uma agora?`, 'Usar Pacote?', 'Sim, Usar');
                        if(usePackage) {
                            const uniqueId = `${item.id}-usage-${Date.now()}`;
                            selectedItems.set(uniqueId, { id: item.id, name: `${item.name} (Uso de Pacote)`, price: 0, quantity: 1, isPackage: false, isPackageUsage: true, type: 'bronze' });
                            renderSelectedItems(); calculateTotal(); return;
                        }
                    }
                }
                 isPackage = await showConfirm(`O serviço "${item.name}" é um pacote de 3 sessões?`, 'Confirmar Pacote', 'Sim, é Pacote');
            }
            const uniqueId = isPackage ? `${item.id}-package` : item.id;
            const type = item.type || item.category;
            if (selectedItems.has(uniqueId) && (type === 'consumable' || type === 'stock')) {
                selectedItems.get(uniqueId).quantity++;
            } else if (!selectedItems.has(uniqueId)) {
                selectedItems.set(uniqueId, { id: item.id, name: isPackage ? `${item.name} (Pacote)` : item.name, price: isPackage ? item.price * 3 : item.price, quantity: 1, isPackage, type, isPackageUsage: false });
            }
            renderSelectedItems(); 
            calculateTotal();
            [ui.bronzeSearch, ui.consumableSearch, ui.stockSearch, ui.extraSearch].forEach(input => input.value = '');
            document.querySelectorAll('[id$="-search-results"]').forEach(c => c.classList.add('hidden'));
        }

        function renderSelectedItems() {
            ui.selectedBronzeItems.innerHTML = ''; ui.selectedConsumableItems.innerHTML = '';
            ui.selectedStockItems.innerHTML = ''; ui.selectedExtraItems.innerHTML = '';
            for (const [uniqueId, item] of selectedItems.entries()) {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                const price = (item.price * item.quantity).toLocaleString('pt-BR',{style:'currency', currency:'BRL'});
                let quantityControls = '';
                if (item.type === 'consumable' || item.type === 'stock') {
                    quantityControls = `<input type="number" value="${item.quantity}" min="1" data-id="${uniqueId}" class="selected-quantity-input w-16 p-1 border rounded-md text-center">`;
                }
                itemEl.innerHTML = `<span>${item.name}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-semibold">${price}</span>
                        ${quantityControls}
                        <button data-id="${uniqueId}" class="remove-item-btn text-red-500 hover:text-red-700"><i data-lucide="x-circle" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>`;
                let container;
                if(item.type === 'bronze') container = ui.selectedBronzeItems;
                else if(item.type === 'consumable') container = ui.selectedConsumableItems;
                else if(item.type === 'stock') container = ui.selectedStockItems;
                else if(item.type === 'extra') container = ui.selectedExtraItems;
                if(container) container.appendChild(itemEl);
            }
            lucide.createIcons();
        }
        
        document.body.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-item-btn');
            if (removeBtn) { selectedItems.delete(removeBtn.dataset.id); renderSelectedItems(); calculateTotal(); }
        });
        document.body.addEventListener('input', (e) => {
            const quantityInput = e.target.closest('.selected-quantity-input');
            if (quantityInput) {
                const item = selectedItems.get(quantityInput.dataset.id);
                if (item) { item.quantity = parseInt(quantityInput.value) || 1; renderSelectedItems(); calculateTotal(); }
            }
        });

        function calculateTotal() {
            let subtotal = 0;
            for (const item of selectedItems.values()) { subtotal += item.price * item.quantity; }
            ui.subtotal.textContent = subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            let discount = 0;
            const discountValue = parseFloat(ui.discountInput.value.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
            if (discountType === 'value') { discount = discountValue; } 
            else { discount = subtotal * (discountValue / 100); }
            ui.discountApplied.textContent = `- ${discount.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}`;
            ui.total.textContent = (subtotal - discount).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        }
        
        document.getElementById('discount-type-value').addEventListener('click', () => {
            discountType = 'value';
            document.getElementById('discount-type-value').classList.replace('bg-gray-100', 'bg-rose-100');
            document.getElementById('discount-type-value').classList.replace('text-gray-500', 'text-rose-700');
            document.getElementById('discount-type-percent').classList.replace('bg-rose-100', 'bg-gray-100');
            document.getElementById('discount-type-percent').classList.replace('text-rose-700', 'text-gray-500');
            calculateTotal();
        });
        document.getElementById('discount-type-percent').addEventListener('click', () => {
            discountType = 'percent';
            document.getElementById('discount-type-percent').classList.replace('bg-gray-100', 'bg-rose-100');
            document.getElementById('discount-type-percent').classList.replace('text-gray-500', 'text-rose-700');
            document.getElementById('discount-type-value').classList.replace('bg-rose-100', 'bg-gray-100');
            document.getElementById('discount-type-value').classList.replace('text-rose-700', 'text-gray-500');
            calculateTotal();
        });
        ui.discountInput.addEventListener('input', calculateTotal);

        function selectClient(client) {
            selectedClient = client;
            ui.clientSearch.value = client.name;
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('selected-client-name').textContent = client.name;
            document.getElementById('selected-client-display').style.display = 'flex';
            const birthdayAlertEl = document.getElementById('birthday-alert');
            if (client.birthdate) {
                 const birthDate = new Date(client.birthdate + 'T00:00:00');
                 birthdayAlertEl.style.display = birthDate.getMonth() === new Date().getMonth() ? 'flex' : 'none';
            } else {
                 birthdayAlertEl.style.display = 'none';
            }
            lucide.createIcons();
        }

        function listenForIncomingOrders(){
            const q = query(collection(db,"businesses", businessId,"incoming_orders"),where("status","==","pending"));
            onSnapshot(q,snapshot=>{
                pendingOrders=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
                const badge=document.getElementById("notification-badge");
                if(pendingOrders.length>0){
                    badge.textContent=pendingOrders.length;
                    badge.classList.remove("hidden");
                    if (snapshot.docChanges().some(c => c.type === 'added') && synth) {
                        synth.triggerAttackRelease("C5","8n");
                    }
                } else {
                    badge.classList.add("hidden");
                }
            })
        }
        
        document.getElementById("incoming-orders-btn").addEventListener("click",()=>{
            const modal=document.getElementById("incoming-orders-modal");
            const list=document.getElementById("incoming-orders-list");
            list.innerHTML = "";
            if(pendingOrders.length===0){
                list.innerHTML='<p class="text-gray-500">Nenhum pedido pendente.</p>';
            } else {
                pendingOrders.forEach(order=>{
                    const orderEl=document.createElement("div");
                    orderEl.className="p-4 border rounded-lg";
                    orderEl.innerHTML=`<div class="flex justify-between items-start"><div><p class="font-bold text-lg">${order.customerName}</p><p class="text-sm text-gray-600">${order.customerPhone}</p><p class="text-sm mt-2">Total: <span class="font-bold">${order.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</span></p></div><div class="flex gap-2"><button class="load-order-btn bg-green-500 text-white px-3 py-1 rounded" data-id="${order.id}">Carregar</button><button class="reject-order-btn bg-red-500 text-white px-3 py-1 rounded" data-id="${order.id}">Rejeitar</button></div></div>`;
                    list.appendChild(orderEl);
                });
            }
            modal.classList.remove("hidden");
        });
        
        document.getElementById("close-orders-modal-btn").addEventListener("click",()=>document.getElementById("incoming-orders-modal").classList.add("hidden"));
        
        document.getElementById("incoming-orders-list").addEventListener("click",async e=>{
            const orderId=e.target.dataset.id;
            if(!orderId) return;

            const orderRef = doc(db,"businesses", businessId,"incoming_orders",orderId);
            if(e.target.classList.contains("load-order-btn")){
                const orderData = pendingOrders.find(o=>o.id===orderId);
                if(orderData){
                    resetSaleForm();
                    ui.clientSearch.value = orderData.customerName;
                    orderData.items.forEach(item => {
                        const product = allStockItems.find(p=>p.name===item.name) || allProducts.find(p=>p.name===item.name) || allProducts.find(p => `${p.name} (Pacote)` === item.name);
                        if(product){
                            const isPackage = item.name.includes("(Pacote)");
                            const uniqueId = isPackage ? `${product.id}-package` : product.id;
                            selectedItems.set(uniqueId, {...product, name: item.name, quantity: item.quantity, price: item.price, type: product.type || product.category, isPackage: isPackage });
                        }
                    });
                    document.getElementById("payment-method").value = orderData.paymentMethod;
                    document.getElementById("order-details").classList.remove("hidden");
                    loadedOnlineOrder = orderData;
                    renderSelectedItems();
                    calculateTotal();
                    document.getElementById("incoming-orders-modal").classList.add("hidden");
                    await updateDoc(orderRef,{status:"loaded"});
                }
            } else if (e.target.classList.contains("reject-order-btn")) {
                if(await showConfirm("Rejeitar este pedido?")){
                    await updateDoc(orderRef,{status:"rejected"});
                    showNotification("Pedido rejeitado.","info");
                }
            }
        });

        document.getElementById('save-sale-btn').addEventListener('click', async () => {
            const saveBtn = document.getElementById('save-sale-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Salvando...';
            lucide.createIcons();
            const totalValue = parseFloat(ui.total.textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            const saleItems = Array.from(selectedItems.values());
            const isServiceSale = saleItems.some(item => item.type !== 'stock');
            if (saleItems.length === 0) { showNotification('Nenhum item selecionado.', 'info'); return; }
            if (totalValue <= 0 && !saleItems.some(i => i.isPackageUsage)) {
                showNotification('O valor da venda não pode ser zero.', 'info'); return;
            }
            const existingSale = editingSaleId ? dailySales.find(s => s.id === editingSaleId) : null;
            let password = null;
if (isServiceSale) {
    // Se for venda de serviço, gera a senha normalmente
    password = editingSaleId ? existingSale.password : await getNextPassword();
} else if (editingSaleId) {
    // Se for edição de uma venda antiga (que pode ter senha), mantém a senha
    password = existingSale.password;
}
            const createdAt = editingSaleId ? existingSale.createdAt : Timestamp.now();
            const salePayload = {
                clientName: selectedClient ? selectedClient.name : ui.clientSearch.value || "Cliente Avulso",
                clientId: selectedClient ? selectedClient.id : null,
                total: totalValue, 
                subtotal: parseFloat(ui.subtotal.textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0,
                discount: parseFloat(ui.discountApplied.textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0,
                paymentMethod: document.getElementById('payment-method').value,
                items: saleItems.map(i => ({ name: i.name, price: i.price, quantity: i.quantity, isPackage: i.isPackage || false, isPackageUsage: i.isPackageUsage || false, type: i.type, id: i.id })),
                createdAt: createdAt, status: isServiceSale ? 'waiting' : 'finished', password: password
            };
            try {
                const batch = writeBatch(db);
                if (selectedClient) {
                    const clientRef = doc(db, "businesses", businessId, "clients", selectedClient.id);
                    const packageUpdates = {};
                    saleItems.forEach(item => {
                        if (item.isPackage) packageUpdates[`packages.${item.name.replace(' (Pacote)', '')}`] = increment(2);
                        if (item.isPackageUsage) packageUpdates[`packages.${item.name.replace(' (Uso de Pacote)', '')}`] = increment(-1);
                    });
                    if (Object.keys(packageUpdates).length > 0) batch.update(clientRef, packageUpdates);
                }
                saleItems.forEach(item => {
                    if (item.type === 'stock') {
                        const stockItemRef = doc(db, "businesses", businessId, "stock_items", item.id);
                        batch.update(stockItemRef, { quantity: increment(-item.quantity) });
                    }
                });
                const saleRef = editingSaleId ? doc(db, "businesses", businessId, "sales", editingSaleId) : doc(collection(db, "businesses", businessId, "sales"));
                batch.set(saleRef, salePayload, { merge: true });
                if (loadedOnlineOrder) {
                    batch.update(doc(db, "businesses", businessId, "incoming_orders", loadedOnlineOrder.id), { status: 'completed' });
                }
                await batch.commit();
                
                if (!editingSaleId && isServiceSale) {
                    document.getElementById('modal-password').textContent = password;
                    const qrContainer = document.getElementById('qrcode-container');
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: `...businessId=${businessId}&id=${saleRef.id}`, width: 160, height: 160 });
                    document.getElementById('password-qr-modal').classList.remove('hidden');
                }
                showNotification(editingSaleId ? 'Venda atualizada!' : 'Venda salva!', 'success');
                resetSaleForm();
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar Venda';
            } catch(e){ console.error(e); showNotification('Erro ao salvar a venda.', 'error');
                      saveBtn.disabled = false;
                      saveBtn.textContent = 'Salvar Venda';
                      }
        });
        
        function resetSaleForm(){
             selectedClient = null; loadedOnlineOrder = null; editingSaleId = null;
             ui.clientSearch.value = '';
             document.getElementById('selected-client-display').style.display = 'none';
             document.getElementById('order-details').classList.add('hidden');
             selectedItems.clear();
             renderSelectedItems();
             calculateTotal();
             document.getElementById('save-sale-btn').textContent = 'Salvar Venda';
        }

        async function getNextPassword() {
            const today = new Date();
            const todayId = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const counterRef = doc(db, "businesses", businessId, "dailyCounters", todayId);
            const counterSnap = await getDoc(counterRef);
            let nextNumber = counterSnap.exists() ? counterSnap.data().lastPassword + 1 : 1;
            await setDoc(counterRef, { lastPassword: nextNumber }, { merge: true });
            return String(nextNumber).padStart(3, '0');
        }

        function listenForDailySales() {
            const tableBody = document.getElementById('daily-sales-table');
            const q = query(collection(db, "businesses", businessId, "sales"), where("createdAt", ">=", new Date(new Date().setHours(0,0,0,0))), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                dailySales = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                tableBody.innerHTML = '';
                if(snapshot.empty) { tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhuma venda hoje.</td></tr>'; return; }
                dailySales.forEach(sale => {
                    const row = tableBody.insertRow();
                    const isCancelled = sale.status === 'cancelled';
                    row.className = `border-b ${isCancelled ? 'bg-red-50 text-gray-400 line-through' : 'hover:bg-gray-50'}`;
                    row.innerHTML = `<td class="p-2 font-mono">${sale.password || 'N/A'}</td>
                                     <td class="p-2 font-semibold">${sale.clientName} ${isCancelled ? `<span class="text-xs text-red-600 font-normal block">(${sale.cancellationReason || 'Cancelado'})</span>` : ''}</td>
                                     <td class="p-2">${sale.createdAt.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</td>
                                     <td class="p-2">${(sale.total || 0).toLocaleString('pt-BR', {style:'currency', currency: 'BRL'})}</td>
                                     <td class="p-2">${sale.paymentMethod}</td>
                                     <td class="p-2 flex items-center gap-2">
                                          <button class="edit-sale-btn p-1 text-gray-500 hover:text-blue-600 ${isCancelled ? 'hidden' : ''}" data-id="${sale.id}"><i data-lucide="pencil" class="w-4 h-4 pointer-events-none"></i></button>
                                          <button class="delete-sale-btn p-1 text-gray-500 hover:text-red-600 ${isCancelled ? 'hidden' : ''}" data-id="${sale.id}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                     </td>`;
                });
                lucide.createIcons();
            });
        }
        
        const dailySalesModal = document.getElementById('daily-sales-modal');
        document.getElementById('show-daily-sales-btn').addEventListener('click', () => dailySalesModal.classList.remove('hidden'));
        document.getElementById('close-daily-sales-btn').addEventListener('click', () => dailySalesModal.classList.add('hidden'));
        document.getElementById('close-qr-modal-btn').addEventListener('click', () => document.getElementById('password-qr-modal').classList.add('hidden'));

        document.getElementById('daily-sales-table').addEventListener('click', (e) => {
            if (e.target.closest('.edit-sale-btn')) handleEditSale(e.target.closest('.edit-sale-btn').dataset.id);
            if (e.target.closest('.delete-sale-btn')) handleDeleteSale(e.target.closest('.delete-sale-btn').dataset.id);
        });

        const cancellationModal = document.getElementById('cancellation-modal');
        document.getElementById('cancel-cancellation-btn').addEventListener('click', () => cancellationModal.classList.add('hidden'));
        document.getElementById('cancellation-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const saleId = e.target.querySelector('#cancellation-sale-id').value;
    const reason = e.target.querySelector('#cancellation-reason').value;
    if (!reason) { showNotification('Por favor, informe o motivo.', 'error'); return; }

    const saleRef = doc(db, "businesses", businessId, "sales", saleId);

    try {
        // 1. Busca os detalhes da venda que será cancelada
        const saleToCancelDoc = await getDoc(saleRef);
        if (!saleToCancelDoc.exists()) {
            showNotification('Erro: Venda não encontrada.', 'error');
            return;
        }
        const saleToCancel = saleToCancelDoc.data();

        // 2. Inicia um "pacote" de operações para garantir que tudo aconteça de uma vez
        const batch = writeBatch(db);

        // 3. Percorre os itens da venda e prepara a devolução ao estoque
        saleToCancel.items.forEach(item => {
            // Verifica se o item é do tipo 'stock' e se ele tem um ID
            if (item.type === 'stock' && item.id) {
                const stockItemRef = doc(db, "businesses", businessId, "stock_items", item.id);
                // Adiciona a quantidade de volta ao estoque
                batch.update(stockItemRef, { quantity: increment(item.quantity) });
            }
        });

        // 4. Prepara a atualização do status da venda
        batch.update(saleRef, { status: 'cancelled', cancellationReason: reason });

        // 5. Executa todas as operações (devolução e cancelamento) de uma vez
        await batch.commit();

        showNotification('Venda cancelada e estoque atualizado!', 'success');
        cancellationModal.classList.add('hidden');

    } catch (error) {
        console.error("Erro ao cancelar venda:", error);
        showNotification('Erro ao cancelar a venda.', 'error');
    }
});
        
        function handleEditSale(saleId) {
            const saleToEdit = dailySales.find(s => s.id === saleId);
            if (!saleToEdit) return;
            resetSaleForm();
            
            editingSaleId = saleId;
            document.getElementById('save-sale-btn').textContent = 'Atualizar Venda';
            
            const client = allClients.find(c => c.id === saleToEdit.clientId);
            if(client) selectClient(client);
            else ui.clientSearch.value = saleToEdit.clientName;

            saleToEdit.items.forEach(item => {
                const uniqueId = item.isPackage ? `${item.id}-package` : item.isPackageUsage ? `${item.id}-usage-${Date.now()}` : item.id;
                selectedItems.set(uniqueId, { ...item });
            });
            
            renderSelectedItems();
            calculateTotal();
            dailySalesModal.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleDeleteSale(saleId) {
            cancellationModal.querySelector('#cancellation-sale-id').value = saleId;
            cancellationModal.querySelector('#cancellation-reason').value = '';
            cancellationModal.classList.remove('hidden');
        }
    </script>
</body>
</html>

