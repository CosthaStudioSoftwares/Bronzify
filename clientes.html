<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <script>
    // --- TRANCA DE SEGURAN√áA DE P√ÅGINA ---
    try {
        const permissionsString = sessionStorage.getItem('userPermissions');
        const currentPageId = window.location.pathname.split('/').pop().replace('.html', '');
        if (!permissionsString) {
            window.location.href = './index.html';
        } else {
            const permissions = JSON.parse(permissionsString);
            const isAdmin = Object.keys(permissions).length === 0;
            if (!isAdmin && permissions[currentPageId] === false) {
                document.write(`
                    <html lang="pt-BR">
                    <body class="bg-gray-100 flex items-center justify-center h-screen">
                        <div class="text-center bg-white p-12 rounded-2xl shadow-lg max-w-lg mx-auto">
                            <h1 class="text-4xl text-gray-800">Acesso Negado</h1>
                            <p class="text-gray-600 mt-2">Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>
                            <a href="./dashboard.html" class="mt-6 inline-block bg-blue-500 text-white px-6 py-2 rounded-lg">Voltar</a>
                        </div>
                    </body>
                    </html>
                `);
            }
        }
    } catch (e) { window.location.href = './index.html'; }
    </script>
    <script>
        if (sessionStorage.getItem('acessoLiberado') !== 'true') { window.location.href = 'dashboard.html'; }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Bronzify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#B76E79">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #FFF9F9; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #FADADD; color: #B76E79; }
        .modal-backdrop { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 opacity-0 transition-opacity duration-300">

    <div class="flex h-screen">
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            
            <div id="alerts-container" class="mb-6 space-y-3 hidden">
                <div id="alert-birthday" class="hidden bg-gradient-to-r from-pink-500 to-rose-400 text-white p-4 rounded-2xl shadow-lg flex items-center justify-between animate-pulse">
                    <div class="flex items-center gap-3">
                        <i data-lucide="cake" class="w-8 h-8"></i>
                        <div>
                            <h4 class="font-bold">Aniversariantes de Hoje!</h4>
                            <p class="text-sm opacity-90">Envie um parab√©ns para fidelizar sua cliente.</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('birthday-filter-btn').click()" class="bg-white text-pink-600 px-4 py-1 rounded-full text-xs font-bold uppercase">Ver agora</button>
                </div>
            </div>

            <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex items-center w-full">
                    <button id="open-menu-btn" class="lg:hidden p-2 -ml-2"><i data-lucide="menu" class="w-6 h-6 text-gray-800"></i></button>
                    <h2 class="text-3xl lg:text-4xl text-gray-800 w-full text-center sm:text-left">Gest√£o de Clientes</h2>
                </div>
                <button id="add-client-btn" class="w-full sm:w-auto bg-[#B76E79] text-white px-4 py-2 rounded-lg hover:opacity-90 flex items-center justify-center gap-2">
                    <i data-lucide="user-plus"></i> <span>Cadastrar Cliente</span>
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h3 class="text-2xl text-gray-800 mb-4">Pesquisar Clientes</h3>
                        <div class="flex flex-col gap-4">
                            <div class="relative flex-grow">
                                <input type="text" id="search-input" placeholder="Nome ou telefone..." class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-[#B76E79]">
                                <div id="search-results" class="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg"></div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <button id="birthday-filter-btn" class="flex-1 bg-pink-100 text-[#B76E79] px-4 py-2 rounded-lg flex items-center justify-center gap-2">
                                    <i data-lucide="cake"></i> Aniversariantes do M√™s
                                </button>
                                <button id="package-filter-btn" class="flex-1 bg-green-100 text-green-700 px-4 py-2 rounded-lg flex items-center justify-center gap-2">
                                    <i data-lucide="package-check"></i> Pacotes Ativos
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <div class="flex bg-gray-100 p-1 rounded-xl mb-6 gap-1">
                            <button id="tab-clients" class="flex-1 py-2 rounded-lg bg-[#B76E79] text-white font-bold transition-all">Lista</button>
                            <button id="tab-agenda" class="flex-1 py-2 rounded-lg text-gray-500 font-bold transition-all">Agenda</button>
                            <button id="tab-recovery" class="flex-1 py-2 rounded-lg text-gray-500 font-bold transition-all">Retorno</button>
                        </div>

                        <div id="view-clients">
                            <div id="clients-list" class="space-y-4"></div>
                            <div id="pagination-controls" class="mt-6 flex justify-between items-center"></div>
                        </div>

                        <div id="view-agenda" class="hidden space-y-6">
                            <div class="bg-amber-50 p-4 rounded-xl border border-amber-200">
                                <h4 class="font-bold text-amber-800 flex items-center gap-2"><i data-lucide="calendar"></i> Agendamentos Pendentes</h4>
                                <p class="text-sm text-amber-700">Aprove ou recuse os hor√°rios solicitados pelas clientes.</p>
                            </div>
                            <div id="agenda-list" class="text-center text-gray-400 py-8">Nenhum agendamento pendente para hoje.</div>
                        </div>

                        <div id="view-recovery" class="hidden space-y-6">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                <label class="text-sm font-bold text-blue-800">Lembrar manuten√ß√£o ap√≥s:</label>
                                <div class="flex gap-2 mt-2">
                                    <input type="number" id="recovery-days" value="10" class="w-20 p-2 border rounded-lg text-center">
                                    <button id="run-recovery-filter" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Filtrar</button>
                                </div>
                            </div>
                            <div id="recovery-list" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-md lg:sticky top-8">
                        <h3 class="text-2xl text-gray-800 mb-4">Sorteio de Clientes</h3>
                        <select id="raffle-months" multiple class="w-full p-2 border rounded-lg h-32 mb-4"></select>
                        <button id="raffle-btn" class="w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white py-3 rounded-xl font-bold shadow-md">Sortear Cliente</button>
                    </div>
                </div>
            </div>
        </main>

        <div id="client-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl w-full max-w-md p-8">
                <h3 id="modal-title" class="text-2xl mb-6">Cliente</h3>
                <form id="client-form" class="space-y-4">
                    <input type="hidden" id="client-id">
                    <input type="text" id="client-name" placeholder="Nome Completo" class="w-full p-3 border rounded-lg" required>
                    <input type="tel" id="client-phone" placeholder="Telefone" class="w-full p-3 border rounded-lg" required>
                    <input type="date" id="client-birthdate" class="w-full p-3 border rounded-lg" required>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" id="cancel-btn" class="px-6 py-2">Cancelar</button>
                        <button type="submit" class="bg-[#B76E79] text-white px-8 py-2 rounded-lg font-bold">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="winner-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-2xl w-full max-w-sm p-8 text-center">
                <i data-lucide="party-popper" class="mx-auto w-16 h-16 text-yellow-500 mb-4"></i>
                <h3 class="text-2xl font-bold mb-2">Parab√©ns!</h3>
                <p id="winner-name" class="text-3xl font-bold text-[#B76E79]"></p>
                <p id="winner-phone" class="text-lg mt-2"></p>
                <button id="close-winner-modal" class="w-full mt-6 bg-[#B76E79] text-white py-2 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <script src="./config.js"></script>
    <script type="module" src="./layout.js"></script>
    <script src="./utils.js"></script> 

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, doc, updateDoc, deleteDoc, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, businessId = null;
        let allClientsData = [], currentClientList = [], studioSettings = {};
        let isBirthdayFilterActive = false, isPackageFilterActive = false, currentPage = 1;
        const CLIENTS_PER_PAGE = 5;

        const clientsListEl = document.getElementById('clients-list');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');

        // --- 1. MARKETING E WHATSAPP ---
        async function loadStudioMessages() {
            const docSnap = await getDocs(collection(db, "businesses", businessId, "settings"));
            studioSettings = docSnap.docs.find(d => d.id === "general")?.data() || {};
        }

        function sendProfessionalWhatsApp(client, type) {
            const firstName = (client.name || 'Cliente').split(' ')[0];
            let message = type === 'birthday' 
                ? (studioSettings.msgBirthday || "Ol√° [NOME], a equipe do [STUDIO] te deseja um feliz anivers√°rio! üéÇ") 
                : (studioSettings.msgReturn || "Oi [NOME], faz tempo que n√£o te vemos no [STUDIO]! Que tal renovar seu bronze?");

            message = message.replace(/\[NOME\]/g, firstName).replace(/\[STUDIO\]/g, studioSettings.studioName || "nosso Studio");
            const phone = client.phone.replace(/\D/g, '');
            window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(message)}`, '_blank');
        }
        window.sendProfessionalWhatsApp = sendProfessionalWhatsApp;

        // --- 2. INICIALIZA√á√ÉO ---
        async function initializePage() {
            try {
                await loadAllClients();
                await loadStudioMessages();
                currentClientList = [...allClientsData];
                checkTodayBirthdays();
                renderPaginatedClients();
                document.body.classList.remove('opacity-0');
            } catch (e) { console.error(e); }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                businessId = sessionStorage.getItem('businessId');
                if (!businessId) { window.location.href = 'index.html'; return; }
                await initializePage();
            } else { window.location.href = 'index.html'; }
        });

        // --- 3. CARREGAMENTO E RENDERIZA√á√ÉO ---
        async function loadAllClients() {
            const snap = await getDocs(query(collection(db, "businesses", businessId, "clients")));
            allClientsData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allClientsData.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        }

        function renderClientItems(clientsToRender) {
            clientsListEl.innerHTML = '';
            const currentMonth = new Date().getMonth() + 1;

            clientsToRender.forEach(client => {
                const birthMonth = client.birthdate ? new Date(client.birthdate + 'T00:00:00').getMonth() + 1 : 0;
                const isBirthday = birthMonth === currentMonth;
                const formattedDate = client.birthdate ? new Date(client.birthdate + 'T00:00:00').toLocaleDateString('pt-BR') : '---';
                
                const el = document.createElement('div');
                el.className = 'flex flex-col sm:flex-row items-center justify-between p-4 bg-white border rounded-xl gap-4 hover:shadow-md transition-all';
                el.innerHTML = `
                    <div class="flex items-center gap-3 w-full">
                        <div class="p-3 bg-pink-50 rounded-full text-pink-500">
                            <i data-lucide="${isBirthday ? 'cake' : 'user'}"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-bold text-gray-800">${client.name}</p>
                            <p class="text-sm text-gray-500">${client.phone}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="p-2 text-pink-500 hover:bg-pink-100 rounded-lg" onclick='sendProfessionalWhatsApp(${JSON.stringify(client).replace(/'/g, "&apos;")}, "birthday")'><i data-lucide="cake"></i></button>
                        <button class="p-2 text-blue-500 hover:bg-blue-100 rounded-lg" onclick='sendProfessionalWhatsApp(${JSON.stringify(client).replace(/'/g, "&apos;")}, "recovery")'><i data-lucide="refresh-cw"></i></button>
                        <button class="edit-btn p-2 text-gray-400 hover:text-blue-600" data-id="${client.id}"><i data-lucide="file-pen-line"></i></button>
                        <button class="delete-btn p-2 text-gray-400 hover:text-red-600" data-id="${client.id}"><i data-lucide="trash-2"></i></button>
                    </div>`;
                clientsListEl.appendChild(el);
            });
            lucide.createIcons();
        }

        function checkTodayBirthdays() {
            const today = new Date().toISOString().substring(5, 10);
            const hasBirthday = allClientsData.some(c => c.birthdate && c.birthdate.substring(5, 10) === today);
            if(hasBirthday) {
                document.getElementById('alerts-container').classList.remove('hidden');
                document.getElementById('alert-birthday').classList.remove('hidden');
            }
        }

        // --- 4. ABAS E NAVEGA√á√ÉO ---
        const tabConfigs = { 'tab-clients': 'view-clients', 'tab-agenda': 'view-agenda', 'tab-recovery': 'view-recovery' };
        Object.keys(tabConfigs).forEach(tabId => {
            document.getElementById(tabId).addEventListener('click', (e) => {
                Object.keys(tabConfigs).forEach(id => {
                    document.getElementById(id).classList.remove('bg-[#B76E79]', 'text-white');
                    document.getElementById(id).classList.add('text-gray-500');
                    document.getElementById(tabConfigs[id]).classList.add('hidden');
                });
                e.currentTarget.classList.add('bg-[#B76E79]', 'text-white');
                document.getElementById(tabConfigs[tabId]).classList.remove('hidden');
            });
        });

        // --- 5. BUSCA E FILTROS ---
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            currentClientList = allClientsData.filter(c => c.name?.toLowerCase().includes(term) || c.phone?.includes(term));
            currentPage = 1; renderPaginatedClients();
        });

        document.getElementById('birthday-filter-btn').addEventListener('click', () => {
            isBirthdayFilterActive = !isBirthdayFilterActive;
            const currentMonth = new Date().getMonth() + 1;
            currentClientList = isBirthdayFilterActive ? allClientsData.filter(c => c.birthdate && new Date(c.birthdate + 'T00:00:00').getMonth() + 1 === currentMonth) : allClientsData;
            renderPaginatedClients();
        });

        // --- 6. MODAL E SALVAMENTO ---
        const modal = document.getElementById('client-modal'), clientForm = document.getElementById('client-form');
        document.getElementById('add-client-btn').addEventListener('click', () => { clientForm.reset(); document.getElementById('client-id').value = ''; modal.classList.remove('hidden'); });
        document.getElementById('cancel-btn').addEventListener('click', () => modal.classList.add('hidden'));

        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('client-id').value;
            const data = { name: document.getElementById('client-name').value, phone: document.getElementById('client-phone').value, birthdate: document.getElementById('client-birthdate').value };
            const ref = collection(db, "businesses", businessId, "clients");
            if(id) await updateDoc(doc(ref, id), data); else await addDoc(ref, data);
            modal.classList.add('hidden'); initializePage();
        });

        // Eventos Delegados (Editar e Excluir)
        clientsListEl.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-btn'), deleteBtn = e.target.closest('.delete-btn');
            if(editBtn) {
                const c = allClientsData.find(cl => cl.id === editBtn.dataset.id);
                document.getElementById('client-id').value = c.id;
                document.getElementById('client-name').value = c.name;
                document.getElementById('client-phone').value = c.phone;
                document.getElementById('client-birthdate').value = c.birthdate;
                modal.classList.remove('hidden');
            }
            if(deleteBtn && await showConfirm('Excluir cliente?')) {
                await deleteDoc(doc(db, "businesses", businessId, "clients", deleteBtn.dataset.id));
                initializePage();
            }
        });

        // --- 7. SORTEIO ---
        const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
        const raffleSelect = document.getElementById('raffle-months');
        months.forEach((m, i) => raffleSelect.add(new Option(m, i)));

        document.getElementById('raffle-btn').addEventListener('click', () => {
            const winner = allClientsData[Math.floor(Math.random() * allClientsData.length)];
            if(winner) {
                document.getElementById('winner-name').textContent = winner.name;
                document.getElementById('winner-phone').textContent = winner.phone;
                document.getElementById('winner-modal').classList.remove('hidden');
            }
        });
        document.getElementById('close-winner-modal').addEventListener('click', () => document.getElementById('winner-modal').classList.add('hidden'));

        // --- 8. PAGINA√á√ÉO SIMPLIFICADA ---
        function renderPaginatedClients() {
            const start = (currentPage - 1) * CLIENTS_PER_PAGE;
            renderClientItems(currentClientList.slice(start, start + CLIENTS_PER_PAGE));
            const totalPages = Math.ceil(currentClientList.length / CLIENTS_PER_PAGE);
            document.getElementById('pagination-controls').innerHTML = totalPages > 1 ? `<span>P√°g ${currentPage}/${totalPages}</span>` : '';
        }

        lucide.createIcons();
    </script>
</body>
</html>
